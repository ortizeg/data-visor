---
phase: 03-filtering-search
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - app/models/view.py
  - app/routers/views.py
  - app/routers/samples.py
  - app/main.py
  - frontend/src/types/view.ts
  - frontend/src/hooks/use-saved-views.ts
  - frontend/src/hooks/use-tags.ts
  - frontend/src/components/filters/search-input.tsx
  - frontend/src/components/filters/sort-controls.tsx
  - frontend/src/components/filters/saved-view-picker.tsx
  - frontend/src/components/filters/filter-sidebar.tsx
  - frontend/src/components/grid/grid-cell.tsx
  - frontend/src/components/grid/image-grid.tsx
  - frontend/src/stores/filter-store.ts
autonomous: true

must_haves:
  truths:
    - "User can search by filename and see the grid filter to matching samples"
    - "User can sort the grid by filename, width, or height in ascending or descending order"
    - "User can save the current filter configuration as a named view and reload it later"
    - "User can select multiple samples via checkboxes and add or remove a tag in bulk"
    - "Tags appear as badges on grid cells for tagged samples"
  artifacts:
    - path: "app/routers/views.py"
      provides: "Saved views CRUD endpoints (create, list, delete)"
      exports: ["router"]
    - path: "app/models/view.py"
      provides: "SavedView Pydantic models"
      contains: "class SavedViewCreate"
    - path: "frontend/src/components/filters/search-input.tsx"
      provides: "Debounced filename search input"
      contains: "SearchInput"
    - path: "frontend/src/components/filters/sort-controls.tsx"
      provides: "Sort by / sort direction controls"
      contains: "SortControls"
    - path: "frontend/src/components/filters/saved-view-picker.tsx"
      provides: "Saved view selector with save and delete"
      contains: "SavedViewPicker"
    - path: "frontend/src/hooks/use-tags.ts"
      provides: "Tag mutation hooks for bulk add/remove"
      exports: ["useBulkTag", "useBulkUntag"]
  key_links:
    - from: "frontend/src/components/filters/search-input.tsx"
      to: "frontend/src/stores/filter-store.ts"
      via: "Debounced local state synced to store setSearch"
      pattern: "setSearch.*setTimeout"
    - from: "frontend/src/components/filters/saved-view-picker.tsx"
      to: "app/routers/views.py"
      via: "useSavedViews hook fetches/creates views via /views endpoints"
      pattern: "apiPost.*views"
    - from: "frontend/src/hooks/use-tags.ts"
      to: "app/routers/samples.py"
      via: "useBulkTag calls PATCH /samples/bulk-tag"
      pattern: "apiPatch.*bulk-tag"
    - from: "frontend/src/components/grid/grid-cell.tsx"
      to: "frontend/src/stores/filter-store.ts"
      via: "Selection state for bulk tagging stored in filter store (selectedSampleIds)"
      pattern: "selectedSampleIds"
---

<objective>
Add search-by-filename with debounce, column sorting, saved view persistence (CRUD to DuckDB), and bulk tagging with checkbox selection to complete all Phase 3 filtering requirements.

Purpose: Delivers FILT-02 (search + sort), FILT-03 (saved views), and FILT-04 (bulk tagging). Completes the full filtering and search feature set.
Output: Fully functional filter sidebar with search, sort, saved views, and tagging. Users can find, organize, and annotate samples efficiently.
</objective>

<execution_context>
@/Users/ortizeg/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ortizeg/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-filtering-search/03-RESEARCH.md
@.planning/phases/03-filtering-search/03-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Backend saved views CRUD and bulk tagging endpoints</name>
  <files>
    app/models/view.py
    app/routers/views.py
    app/routers/samples.py
    app/main.py
  </files>
  <action>
    **1. Saved view models (NEW file: app/models/view.py):**
    ```python
    from datetime import datetime
    from pydantic import BaseModel

    class SavedViewCreate(BaseModel):
        dataset_id: str
        name: str
        filters: dict  # Serialized filter state from frontend

    class SavedViewResponse(BaseModel):
        id: str
        dataset_id: str
        name: str
        filters: dict
        created_at: datetime
        updated_at: datetime

    class SavedViewListResponse(BaseModel):
        views: list[SavedViewResponse]
    ```

    **2. Saved views router (NEW file: app/routers/views.py):**
    CRUD endpoints for saved filter configurations:

    - `POST /views` -- Create a named view. Generate UUID for id. Insert into saved_views table with `?::JSON` cast for filters column. Return the created view as SavedViewResponse.
    - `GET /views` -- List views for a dataset. Accept `dataset_id` as Query param. SELECT from saved_views WHERE dataset_id = ? ORDER BY created_at DESC. Return SavedViewListResponse.
    - `DELETE /views/{view_id}` -- Delete a view by id. DELETE FROM saved_views WHERE id = ?. Return 204 No Content.

    Use cursor-per-request pattern (cursor in try/finally) matching existing router patterns. Import uuid and json for UUID generation and filter serialization.

    **3. Bulk tagging endpoints (app/routers/samples.py):**

    Add Pydantic request model `BulkTagRequest`:
    ```python
    class BulkTagRequest(BaseModel):
        dataset_id: str
        sample_ids: list[str]
        tag: str
    ```
    This can go in app/models/sample.py or inline in the router -- put it in app/models/sample.py for consistency.

    Add two endpoints:

    - `PATCH /samples/bulk-tag` -- Add a tag to multiple samples.
      - Parse sample_ids from request body
      - Cap at 500 sample_ids per request (HTTPException 400 if exceeded)
      - SQL: `UPDATE samples SET tags = list_distinct(list_append(COALESCE(tags, []), ?)) WHERE dataset_id = ? AND id IN ({placeholders})`
      - Params: [tag, dataset_id, *sample_ids]
      - Return `{"tagged": len(sample_ids)}`
      - These endpoints MUST be defined BEFORE the `/{sample_id}/annotations` path route to avoid FastAPI route conflicts

    - `PATCH /samples/bulk-untag` -- Remove a tag from multiple samples.
      - Same structure as bulk-tag
      - SQL: `UPDATE samples SET tags = list_filter(COALESCE(tags, []), x -> x != ?) WHERE dataset_id = ? AND id IN ({placeholders})`
      - Params: [tag, dataset_id, *sample_ids]
      - Return `{"untagged": len(sample_ids)}`

    **4. Register views router (app/main.py):**
    - Import views router: `from app.routers import datasets, images, samples, views`
    - Add: `app.include_router(views.router)`
  </action>
  <verify>
    Run backend tests:
    ```bash
    cd /Users/ortizeg/1Projects/⛹️‍♂️\ Next\ Play/code/data-visor && python -m pytest tests/ -x -q
    ```
    Verify views router loads:
    ```bash
    python -c "from app.routers.views import router; print('Views router OK:', [r.path for r in router.routes])"
    ```
    Verify models import:
    ```bash
    python -c "from app.models.view import SavedViewCreate, SavedViewResponse, SavedViewListResponse; print('View models OK')"
    ```
    Verify tagging SQL works:
    ```bash
    python -c "
    from app.repositories.duckdb_repo import DuckDBRepo
    db = DuckDBRepo(':memory:')
    db.initialize_schema()
    c = db.connection.cursor()
    c.execute(\"INSERT INTO samples VALUES ('s1', 'd1', 'test.jpg', 100, 100, NULL, 'train', NULL, [])\")
    c.execute(\"UPDATE samples SET tags = list_distinct(list_append(COALESCE(tags, []), ?)) WHERE id = ?\", ['my-tag', 's1'])
    tags = c.execute('SELECT tags FROM samples WHERE id = ?', ['s1']).fetchone()[0]
    assert tags == ['my-tag'], f'Expected [my-tag], got {tags}'
    c.execute(\"UPDATE samples SET tags = list_filter(COALESCE(tags, []), x -> x != ?) WHERE id = ?\", ['my-tag', 's1'])
    tags = c.execute('SELECT tags FROM samples WHERE id = ?', ['s1']).fetchone()[0]
    assert tags == [], f'Expected [], got {tags}'
    c.close()
    db.close()
    print('Tagging SQL OK')
    "
    ```
  </verify>
  <done>
    - POST /views creates a saved view with filter config as JSON
    - GET /views returns all saved views for a dataset
    - DELETE /views/{view_id} removes a saved view
    - PATCH /samples/bulk-tag adds a tag to multiple samples using list_append + list_distinct + COALESCE
    - PATCH /samples/bulk-untag removes a tag using list_filter + COALESCE
    - All existing tests still pass
  </done>
</task>

<task type="auto">
  <name>Task 2: Frontend search, sort, saved views, and bulk tagging UI</name>
  <files>
    frontend/src/types/view.ts
    frontend/src/hooks/use-saved-views.ts
    frontend/src/hooks/use-tags.ts
    frontend/src/components/filters/search-input.tsx
    frontend/src/components/filters/sort-controls.tsx
    frontend/src/components/filters/saved-view-picker.tsx
    frontend/src/components/filters/filter-sidebar.tsx
    frontend/src/components/grid/grid-cell.tsx
    frontend/src/components/grid/image-grid.tsx
    frontend/src/stores/filter-store.ts
  </files>
  <action>
    **1. View types (NEW file: frontend/src/types/view.ts):**
    ```typescript
    export interface SavedView {
      id: string;
      dataset_id: string;
      name: string;
      filters: Record<string, unknown>;
      created_at: string;
      updated_at: string;
    }
    export interface SavedViewList {
      views: SavedView[];
    }
    ```

    **2. Extend filter store (frontend/src/stores/filter-store.ts):**
    Add selection state for bulk tagging:
    - `selectedSampleIds: Set<string>` (empty by default)
    - `toggleSampleSelection: (id: string) => void` -- toggles id in/out of Set
    - `selectAllVisible: (ids: string[]) => void` -- replaces Set with given ids
    - `clearSelection: () => void` -- empties the Set
    - `isSelecting: boolean` (false by default) -- toggle for selection mode
    - `setIsSelecting: (v: boolean) => void`
    - Export `useSelectedSampleIds`, `useIsSelecting` atomic selectors
    - Include selectedSampleIds in DEFAULT_FILTERS reset (clearFilters should also clear selection)
    - NOTE: Do NOT include selectedSampleIds or isSelecting in the filter state that goes into the TanStack Query key -- these are UI-only state

    **3. Search input component (NEW file: frontend/src/components/filters/search-input.tsx):**
    Follow 03-RESEARCH.md Pattern 6 exactly:
    - Local state `localValue` for immediate input feedback
    - `useEffect` with 300ms setTimeout debounce to sync localValue -> store setSearch
    - `useEffect` to sync store search -> localValue (for saved view loading)
    - `<input type="search">` with placeholder "Search by filename..."
    - Tailwind classes: `w-full rounded-md border border-zinc-300 px-3 py-1.5 text-sm dark:border-zinc-600 dark:bg-zinc-800 dark:text-zinc-100`

    **4. Sort controls component (NEW file: frontend/src/components/filters/sort-controls.tsx):**
    - Two controls: sort field dropdown and sort direction toggle button
    - Sort field options: "ID" (id), "Filename" (file_name), "Width" (width), "Height" (height)
    - Sort direction: toggle button showing ASC/DESC arrow icon (simple text arrow: up/down)
    - Read sortBy and sortDir from filter store, dispatch setSortBy and setSortDir
    - Render as a compact row: `<label>` + `<select>` + direction button

    **5. Saved view picker (NEW file: frontend/src/components/filters/saved-view-picker.tsx):**
    - Props: `datasetId: string`
    - Uses useSavedViews hook to list existing views
    - Dropdown showing saved view names + "Save current..." option
    - When a saved view is selected: call `applyView(view.filters)` on filter store
    - "Save current..." triggers a prompt (window.prompt for simplicity) for view name, then calls create mutation
    - Delete button (small "x") next to each view in dropdown
    - After save/delete, invalidate the saved-views query

    **6. Saved views hook (NEW file: frontend/src/hooks/use-saved-views.ts):**
    - `useSavedViews(datasetId)`: useQuery fetching GET /views?dataset_id=...
    - `useCreateView()`: useMutation calling apiPost to POST /views, onSuccess invalidates ["saved-views", datasetId]
    - `useDeleteView()`: useMutation calling apiDelete to DELETE /views/{id}, onSuccess invalidates ["saved-views", datasetId]
    - Import apiPost, apiDelete from @/lib/api
    - Import useQueryClient from @tanstack/react-query for invalidation

    **7. Tags hook (NEW file: frontend/src/hooks/use-tags.ts):**
    - `useBulkTag()`: useMutation calling apiPatch to PATCH /samples/bulk-tag with {dataset_id, sample_ids, tag}
      - onSuccess: invalidate ["samples"] and ["filter-facets"] queries (new tag may appear in facets)
    - `useBulkUntag()`: useMutation calling apiPatch to PATCH /samples/bulk-untag with same shape
      - onSuccess: invalidate ["samples"] and ["filter-facets"] queries
    - Import useQueryClient for invalidation

    **8. Update FilterSidebar (frontend/src/components/filters/filter-sidebar.tsx):**
    Add SearchInput, SortControls, SavedViewPicker, and a tag action bar to the existing sidebar:
    - Import and render SearchInput before the category/split selects
    - Import and render SortControls after the filter selects
    - Import and render SavedViewPicker at the bottom of the sidebar
    - Add a "Bulk Tag" section that appears when isSelecting is true:
      - Show count of selected samples
      - Text input for tag name + "Add Tag" button + "Remove Tag" button
      - Call useBulkTag / useBulkUntag mutations
      - After tagging, clear selection
    - Add a "Select mode" toggle button at the top of the sidebar (toggles isSelecting)

    **9. Update GridCell (frontend/src/components/grid/grid-cell.tsx):**
    - Import useIsSelecting, useFilterStore from filter-store
    - When isSelecting is true:
      - Show a checkbox overlay in the top-left corner of the cell
      - Checkbox checked state from selectedSampleIds.has(sample.id)
      - onClick toggles selection (calls toggleSampleSelection) instead of opening detail modal
      - When NOT selecting, keep existing click-to-open-modal behavior
    - Show tag badges below the filename if sample.tags has entries:
      - Small colored badges (bg-blue-100 dark:bg-blue-900 text-xs) with tag text
      - Max 3 visible, then "+N more" indicator

    **10. Update ImageGrid (frontend/src/components/grid/image-grid.tsx):**
    - Pass selectedSampleIds Set down to GridCell (or let GridCell read from store directly -- prefer store)
    - When isSelecting is true, add a floating action bar at the bottom of the grid with:
      - "Select All Visible" button (calls selectAllVisible with all currently loaded sample IDs)
      - "Clear Selection" button
      - Selected count display
  </action>
  <verify>
    Build the frontend:
    ```bash
    cd /Users/ortizeg/1Projects/⛹️‍♂️\ Next\ Play/code/data-visor/frontend && npm run build 2>&1 | tail -20
    ```
  </verify>
  <done>
    - Search input debounces keystrokes (300ms) and filters grid by filename
    - Sort controls allow sorting by id, file_name, width, height in asc/desc order
    - SavedViewPicker lists saved views, loads a view's filters into the store, saves current filters as a new view, deletes views
    - Bulk tagging: selection mode enables checkboxes on grid cells, "Select All Visible" / "Clear Selection" controls work, tag input + "Add Tag" / "Remove Tag" buttons apply tags via bulk endpoints
    - Tag badges display on grid cells for tagged samples
    - Filter-facets query invalidated after tag mutations (new tags appear in dropdown)
    - Frontend builds without TypeScript errors
  </done>
</task>

</tasks>

<verification>
1. Start backend and frontend
2. **Search:** Type a partial filename in the search box -- grid should filter after 300ms debounce. Clear the search -- grid returns to full view.
3. **Sort:** Change sort to "Filename" + "DESC" -- grid should reorder. Switch back to "ID" + "ASC" -- grid returns to default order.
4. **Saved views:** Set some filters (category + sort), click "Save current..." in SavedViewPicker, enter a name. The view appears in the dropdown. Clear all filters. Select the saved view -- filters should restore. Delete the saved view.
5. **Bulk tagging:** Toggle "Select mode" on. Click several grid cells to select them (checkboxes appear). Enter a tag name, click "Add Tag". Toggle select mode off -- tag badges should appear on the tagged cells. Verify the tag appears in the Tags filter dropdown (facets invalidated).
6. **Remove tag:** Re-enter select mode, select the same samples, enter the same tag, click "Remove Tag". Badges should disappear.
7. Verify all filters work together: category + search + sort simultaneously.
</verification>

<success_criteria>
- Search by filename works with 300ms debounce
- Sort by any of id/file_name/width/height in asc/desc
- Save current filter config as named view, load it, delete it
- Bulk tag: select mode with checkboxes, add tag, remove tag
- Tag badges visible on grid cells
- All filters compose correctly (category + split + search + sort)
- Frontend builds cleanly
- Backend tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/03-filtering-search/03-02-SUMMARY.md`
</output>
