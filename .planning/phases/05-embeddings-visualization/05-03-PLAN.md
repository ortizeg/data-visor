---
phase: 05-embeddings-visualization
plan: 03
type: execute
wave: 3
depends_on: ["05-02"]
files_modified:
  - frontend/package.json
  - frontend/src/components/embedding/embedding-scatter.tsx
  - frontend/src/components/embedding/hover-thumbnail.tsx
  - frontend/src/components/embedding/embedding-panel.tsx
  - frontend/src/hooks/use-embeddings.ts
  - frontend/src/hooks/use-embedding-progress.ts
  - frontend/src/types/embedding.ts
  - frontend/src/stores/ui-store.ts
  - frontend/src/app/datasets/[datasetId]/page.tsx
autonomous: true

must_haves:
  truths:
    - "User can switch to an 'Embeddings' tab on the dataset page and see a 2D scatter plot"
    - "Scatter plot renders points for each sample using deck.gl with zoom and pan"
    - "User can hover over a point and see the image thumbnail in a tooltip"
    - "Scatter plot fetches 2D coordinates from GET /embeddings/coordinates"
    - "If no embeddings exist, the panel shows a 'Generate Embeddings' button"
    - "User can trigger embedding generation and UMAP reduction from the panel with progress feedback"
    - "WebGL context loss triggers automatic recovery (re-mount)"
  artifacts:
    - path: "frontend/src/components/embedding/embedding-scatter.tsx"
      provides: "deck.gl DeckGL with OrthographicView and ScatterplotLayer"
      contains: "OrthographicView"
    - path: "frontend/src/components/embedding/hover-thumbnail.tsx"
      provides: "Tooltip showing image thumbnail on point hover"
      contains: "thumbnailUrl"
    - path: "frontend/src/components/embedding/embedding-panel.tsx"
      provides: "Container with scatter plot, empty state with generate button, progress bar"
      contains: "EmbeddingScatter"
    - path: "frontend/src/hooks/use-embeddings.ts"
      provides: "TanStack Query hooks for coordinates, status, generate, reduce mutations"
      exports: ["useEmbeddingCoordinates", "useEmbeddingStatus", "useGenerateEmbeddings", "useReduceEmbeddings"]
    - path: "frontend/src/hooks/use-embedding-progress.ts"
      provides: "EventSource hook for SSE progress streams"
      exports: ["useEmbeddingProgress"]
    - path: "frontend/src/types/embedding.ts"
      provides: "TypeScript types for embedding API responses"
      exports: ["EmbeddingPoint", "EmbeddingStatus", "EmbeddingProgress"]
  key_links:
    - from: "frontend/src/hooks/use-embeddings.ts"
      to: "/datasets/{id}/embeddings/coordinates"
      via: "TanStack Query fetch"
      pattern: "embeddings/coordinates"
    - from: "frontend/src/components/embedding/embedding-scatter.tsx"
      to: "frontend/src/hooks/use-embeddings.ts"
      via: "useEmbeddingCoordinates provides points data to ScatterplotLayer"
      pattern: "useEmbeddingCoordinates"
    - from: "frontend/src/app/datasets/[datasetId]/page.tsx"
      to: "frontend/src/components/embedding/embedding-panel.tsx"
      via: "Tab system renders EmbeddingPanel when activeTab === 'embeddings'"
      pattern: "activeTab.*embeddings"
---

<objective>
Build the deck.gl 2D scatter plot visualization for embedding coordinates, with hover thumbnails, WebGL recovery, and integration into the dataset page tab system.

Purpose: This transforms the backend embedding data into an interactive visual exploration tool. Users can see how their dataset clusters in embedding space, identify outlier regions, and hover to see individual images -- enabling intuitive dataset understanding.

Output: A deck.gl scatter plot component with OrthographicView, hover thumbnail tooltip, embedding panel with generate/reduce buttons and progress, and a new "Embeddings" tab on the dataset page.
</objective>

<execution_context>
@/Users/ortizeg/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ortizeg/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-embeddings-visualization/05-RESEARCH.md
@.planning/phases/05-embeddings-visualization/05-02-SUMMARY.md

Source files to reference (read before implementing):
@frontend/src/app/datasets/[datasetId]/page.tsx -- Tab system to extend with "Embeddings" tab
@frontend/src/stores/ui-store.ts -- DatasetTab type and activeTab state to extend
@frontend/src/hooks/use-samples.ts -- TanStack Query hook pattern to replicate
@frontend/src/hooks/use-statistics.ts -- TanStack Query hook pattern
@frontend/src/components/stats/stats-dashboard.tsx -- Dashboard panel pattern to replicate
@frontend/src/lib/api.ts -- apiFetch and apiPost helpers, thumbnailUrl helper
@frontend/src/lib/constants.ts -- API_BASE constant
@frontend/src/types/dataset.ts -- TypeScript type pattern
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install frontend deps, create types and data-fetching hooks</name>
  <files>
    frontend/package.json
    frontend/src/types/embedding.ts
    frontend/src/hooks/use-embeddings.ts
    frontend/src/hooks/use-embedding-progress.ts
  </files>
  <action>
    **1. Install frontend dependencies:**
    ```bash
    cd /Users/ortizeg/1Projects/⛹️‍♂️\ Next\ Play/code/data-visor/frontend
    npm install @deck.gl/core @deck.gl/layers @deck.gl/react robust-point-in-polygon
    npm install -D @types/robust-point-in-polygon
    ```

    **2. Create `frontend/src/types/embedding.ts`:**
    ```typescript
    export interface EmbeddingPoint {
      sampleId: string;
      x: number;
      y: number;
      fileName: string;
      thumbnailPath: string | null;
    }

    export interface EmbeddingStatus {
      dataset_id: string;
      has_embeddings: boolean;
      embedding_count: number;
      model_name: string | null;
      has_reduction: boolean;
    }

    export interface EmbeddingProgress {
      status: "idle" | "running" | "fitting" | "complete" | "error";
      processed?: number;
      total?: number;
      message: string;
    }
    ```

    **3. Create `frontend/src/hooks/use-embedding-progress.ts`:**
    Custom hook wrapping EventSource for SSE progress streams.
    - `useEmbeddingProgress(url: string, enabled: boolean)`: returns `{ progress: EmbeddingProgress }`
    - Uses `useEffect` to create `EventSource` when `enabled=true`
    - On "progress" event (or generic `onmessage`): parse JSON, set state
    - On "complete" or "error" status: call `source.close()` (Pitfall 6 from research -- prevent auto-reconnect)
    - Cleanup: `source.close()` on unmount
    - Return `{ status: "idle", message: "" }` when not enabled

    **4. Create `frontend/src/hooks/use-embeddings.ts`:**
    TanStack Query hooks for embedding data:
    - `useEmbeddingStatus(datasetId: string)`: `useQuery` fetching `GET /datasets/{datasetId}/embeddings/status`. Returns `EmbeddingStatus`. staleTime: 30s. queryKey: `["embedding-status", datasetId]`.
    - `useEmbeddingCoordinates(datasetId: string, enabled: boolean)`: `useQuery` fetching `GET /datasets/{datasetId}/embeddings/coordinates`. Returns `EmbeddingPoint[]`. Only fetch when `enabled=true` (has_reduction is true). staleTime: Infinity (coordinates don't change until re-reduction). queryKey: `["embedding-coordinates", datasetId]`.
    - `useGenerateEmbeddings(datasetId: string)`: `useMutation` calling `POST /datasets/{datasetId}/embeddings/generate`. On success, invalidate `["embedding-status", datasetId]`.
    - `useReduceEmbeddings(datasetId: string)`: `useMutation` calling `POST /datasets/{datasetId}/embeddings/reduce`. On success, invalidate `["embedding-status", datasetId]` and `["embedding-coordinates", datasetId]`.
  </action>
  <verify>
    - `cd /Users/ortizeg/1Projects/⛹️‍♂️\ Next\ Play/code/data-visor/frontend && npx tsc --noEmit` -- no TypeScript errors in new files
    - `npm ls @deck.gl/core @deck.gl/layers @deck.gl/react robust-point-in-polygon` -- all dependencies installed
  </verify>
  <done>
    deck.gl and robust-point-in-polygon installed. TypeScript types mirror backend models. useEmbeddingProgress provides SSE event stream consumption. useEmbeddingCoordinates/Status/Generate/Reduce hooks provide full data-fetching layer for the embedding UI.
  </done>
</task>

<task type="auto">
  <name>Task 2: Scatter plot component, hover thumbnail, embedding panel, and tab integration</name>
  <files>
    frontend/src/components/embedding/embedding-scatter.tsx
    frontend/src/components/embedding/hover-thumbnail.tsx
    frontend/src/components/embedding/embedding-panel.tsx
    frontend/src/stores/ui-store.ts
    frontend/src/app/datasets/[datasetId]/page.tsx
  </files>
  <action>
    **1. Create `frontend/src/components/embedding/hover-thumbnail.tsx`:**
    Simple tooltip component that shows an image thumbnail:
    ```tsx
    interface HoverThumbnailProps {
      x: number;        // screen x
      y: number;        // screen y
      fileName: string;
      thumbnailUrl: string;
    }
    ```
    - Absolutely positioned div at (x + 16, y + 16) offset from cursor
    - Shows 120x120 `<img>` with the thumbnail URL
    - File name below the image in small text
    - Dark background with rounded corners and shadow for contrast
    - `pointer-events-none` so it doesn't interfere with hover detection

    **2. Create `frontend/src/components/embedding/embedding-scatter.tsx`:**
    The deck.gl scatter plot component:
    ```tsx
    interface Props {
      points: EmbeddingPoint[];
      onHover?: (point: EmbeddingPoint | null, screenX: number, screenY: number) => void;
    }
    ```
    - Import `DeckGL` from `@deck.gl/react`, `OrthographicView` from `@deck.gl/core`, `ScatterplotLayer` from `@deck.gl/layers`
    - Initial view state: `{ target: [0, 0, 0], zoom: 1, minZoom: -2, maxZoom: 10 }`
    - Create `ScatterplotLayer`:
      - `id: "embedding-scatter"`
      - `data: points`
      - `getPosition: (d) => [d.x, d.y, 0]`
      - `getRadius: 3`
      - `radiusMinPixels: 2, radiusMaxPixels: 8`
      - `getFillColor: [100, 120, 220, 200]` -- blue-ish default (later plans can add class-based coloring)
      - `pickable: true`
      - `onHover: (info) => onHover?.(info.object ?? null, info.x, info.y)`
      - `autoHighlight: true`
      - `highlightColor: [255, 200, 0, 200]`
    - Use `useMemo` for the layer to avoid recreating on every render (anti-pattern from research)
    - Render: `<DeckGL views={new OrthographicView({ id: "ortho", controller: true })} initialViewState={INITIAL_VIEW_STATE} layers={[layer]} />`
    - **WebGL context loss recovery (Pitfall 4 from research):**
      - Use a `key` state variable (e.g., `deckKey`)
      - Add `onWebGLInitialized` callback that attaches a `webglcontextlost` listener to the canvas
      - On context loss: save current viewState, increment `deckKey` to remount the component, restore viewState
      - Alternatively, use a simpler approach: wrap DeckGL in a component with a `useEffect` that listens for `webglcontextlost` on the container div's canvas element

    **3. Create `frontend/src/components/embedding/embedding-panel.tsx`:**
    Container component managing the full embedding workflow:
    - Fetch embedding status with `useEmbeddingStatus(datasetId)`
    - Three states:
      a. **No embeddings:** Show empty state with "Generate Embeddings" button. On click: call `generateMutation.mutate()`, enable SSE progress hook. Show progress bar (processed/total) while running.
      b. **Embeddings but no reduction:** Show "Run UMAP" button. On click: call `reduceMutation.mutate()`, enable reduction SSE progress. Show "Fitting UMAP..." spinner while running.
      c. **Has reduction:** Fetch coordinates with `useEmbeddingCoordinates(datasetId, true)`. Render `<EmbeddingScatter points={coordinates} />` and `<HoverThumbnail>` positioned by hover state.
    - Progress bar component: simple div with width percentage `(processed/total * 100)%`, tailwind styling
    - "Re-generate" button (small, secondary) visible when has_embeddings is true, to re-run the pipeline
    - Layout: full height of the content area (flex-1), scatter plot fills available space

    **4. Extend `frontend/src/stores/ui-store.ts`:**
    - Update `DatasetTab` type: `"grid" | "statistics" | "embeddings"`
    - No other changes needed -- the `setActiveTab` already accepts any DatasetTab value

    **5. Update `frontend/src/app/datasets/[datasetId]/page.tsx`:**
    - Add "Embeddings" to `TAB_OPTIONS`: `{ value: "embeddings", label: "Embeddings" }`
    - Add conditional render: when `activeTab === "embeddings"`, render `<EmbeddingPanel datasetId={datasetId} />`
    - Import `EmbeddingPanel` from `@/components/embedding/embedding-panel`
    - The filter sidebar should be hidden when on embeddings tab (same as statistics tab)

    **Important anti-patterns to avoid:**
    - Do NOT use `MapView` -- use `OrthographicView` for non-geographic 2D data (research Pattern 3)
    - Do NOT recreate layers on every render -- use `useMemo` with appropriate dependencies
    - Do NOT send 768-dim vectors to the frontend -- only 2D (x, y) coordinates
  </action>
  <verify>
    - `cd /Users/ortizeg/1Projects/⛹️‍♂️\ Next\ Play/code/data-visor/frontend && npx tsc --noEmit` -- no TypeScript errors
    - `npm run build` -- build succeeds (or at least no type/import errors)
    - Visually verify: The dataset page shows 3 tabs (Grid, Statistics, Embeddings)
    - Verify embedding-scatter.tsx uses OrthographicView (not MapView)
  </verify>
  <done>
    deck.gl scatter plot renders 2D embedding coordinates with zoom, pan, and hover thumbnails. EmbeddingPanel manages the full workflow (generate -> reduce -> visualize) with progress feedback. "Embeddings" tab added to dataset page. WebGL context loss recovery prevents black canvas on tab background.
  </done>
</task>

</tasks>

<verification>
1. `cd frontend && npx tsc --noEmit` -- no TypeScript errors
2. `npm run build` -- build succeeds
3. Dataset page shows 3 tabs: Grid, Statistics, Embeddings
4. Embeddings tab shows either empty state (generate button) or scatter plot depending on data
5. Scatter plot uses OrthographicView and ScatterplotLayer (check imports in source)
6. Hover tooltip shows image thumbnail
</verification>

<success_criteria>
- deck.gl scatter plot renders with OrthographicView (not MapView)
- Points are pickable with hover highlighting
- Hover shows image thumbnail tooltip at cursor position
- "Embeddings" tab integrates into existing tab system
- Empty state guides user through generate -> reduce workflow with progress bars
- WebGL context loss triggers component remount
- No TypeScript errors, build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/05-embeddings-visualization/05-03-SUMMARY.md`
</output>
