---
phase: 08-docker-deployment-auth
plan: 03
type: execute
wave: 2
depends_on: ["08-01", "08-02"]
files_modified:
  - docker-compose.yml
  - .dockerignore
  - .env.example
  - .gitignore
autonomous: true

must_haves:
  truths:
    - "docker compose up --build starts all 3 services (backend, frontend, caddy) without errors"
    - "DuckDB, Qdrant, and thumbnail data persists across container restarts via bind mount"
    - "Only ports 80 and 443 are exposed to the host"
    - "Auth credentials are configured via .env file, not hardcoded"
  artifacts:
    - path: "docker-compose.yml"
      provides: "3-service orchestration with volume mounts and env vars"
      contains: "services:"
    - path: ".dockerignore"
      provides: "Excludes data, venv, git, tests from Docker build context"
      contains: ".venv"
    - path: ".env.example"
      provides: "Template with all required env vars including Docker-specific ones"
      contains: "AUTH_PASSWORD_HASH"
  key_links:
    - from: "docker-compose.yml"
      to: "Dockerfile.backend"
      via: "build.dockerfile reference"
      pattern: "Dockerfile.backend"
    - from: "docker-compose.yml"
      to: "Dockerfile.frontend"
      via: "build.dockerfile reference"
      pattern: "Dockerfile.frontend"
    - from: "docker-compose.yml"
      to: "Caddyfile"
      via: "volume mount for Caddy config"
      pattern: "Caddyfile:/etc/caddy/Caddyfile"
    - from: "docker-compose.yml"
      to: ".env"
      via: "Docker Compose auto-reads .env file for variable interpolation"
      pattern: "\\$\\{.*\\}"
---

<objective>
Create Docker Compose orchestration, .dockerignore, and update environment configuration.

Purpose: Docker Compose ties together the three services (backend, frontend, Caddy) with proper networking, volume mounts for data persistence, and environment variable configuration. The .dockerignore prevents unnecessary files from entering build contexts.
Output: docker-compose.yml, .dockerignore, updated .env.example, updated .gitignore
</objective>

<execution_context>
@/Users/ortizeg/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ortizeg/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-docker-deployment-auth/08-RESEARCH.md

@.planning/phases/08-docker-deployment-auth/08-01-SUMMARY.md
@.planning/phases/08-docker-deployment-auth/08-02-SUMMARY.md

@.env.example
@.gitignore
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create docker-compose.yml with 3-service stack</name>
  <files>docker-compose.yml</files>
  <action>
Create `docker-compose.yml` at project root with these 3 services:

**backend:**
- build.context: `.` (project root)
- build.dockerfile: `Dockerfile.backend`
- volumes: `./data:/app/data` (bind mount for DuckDB + Qdrant + thumbnails -- DIRECTORY mount, NOT file mount)
- environment:
  - `DATAVISOR_DB_PATH=/app/data/datavisor.duckdb`
  - `DATAVISOR_QDRANT_PATH=/app/data/qdrant`
  - `DATAVISOR_THUMBNAIL_CACHE_DIR=/app/data/thumbnails`
  - `DATAVISOR_VLM_DEVICE=cpu`
  - `DATAVISOR_BEHIND_PROXY=true`
- restart: `unless-stopped`
- stop_grace_period: `30s` (gives DuckDB time to CHECKPOINT and close on shutdown -- default 10s may not be enough during large ingestion)
- healthcheck:
  - test: `["CMD", "curl", "-f", "http://localhost:8000/health"]`
  - interval: 30s
  - timeout: 10s
  - retries: 3
  - start_period: 60s (backend needs time to load DINOv2 embedding model at startup)
- Do NOT expose any ports (Caddy is the only entry point)

**frontend:**
- build.context: `./frontend`
- build.dockerfile: `../Dockerfile.frontend`
- build.args: `NEXT_PUBLIC_API_URL=/api`
- depends_on: `backend`
- restart: `unless-stopped`
- Do NOT expose any ports

**caddy:**
- image: `caddy:2-alpine`
- ports: `"80:80"` and `"443:443"`
- volumes:
  - `./Caddyfile:/etc/caddy/Caddyfile:ro` (read-only mount)
  - `caddy_data:/data` (named volume for Let's Encrypt certs)
  - `caddy_config:/config` (named volume for Caddy config cache)
- environment (using Docker Compose variable interpolation from .env file):
  - `DOMAIN=${DOMAIN:-localhost}`
  - `AUTH_USERNAME=${AUTH_USERNAME:-admin}`
  - `AUTH_PASSWORD_HASH=${AUTH_PASSWORD_HASH}`
- depends_on: `frontend` and `backend`
- restart: `unless-stopped`

**Top-level volumes:**
- `caddy_data:` (named volume, stores Let's Encrypt certificates)
- `caddy_config:` (named volume, Caddy runtime config)

IMPORTANT: Only Caddy exposes ports (80, 443). Backend and frontend are Docker-internal only.
IMPORTANT: `./data:/app/data` is a DIRECTORY bind mount. DuckDB creates WAL and temp files alongside the .duckdb file -- mounting individual files loses these sibling files.
IMPORTANT: `AUTH_PASSWORD_HASH` has no default value (unlike DOMAIN and AUTH_USERNAME). This is intentional -- Caddy will error on startup if no password hash is set, preventing running without auth.
  </action>
  <verify>Run `docker compose config` from the project root to validate the compose file syntax (will show warnings about missing .env vars but should not error on YAML structure).</verify>
  <done>docker-compose.yml exists with 3 services (backend, frontend, caddy), proper volume mounts, environment variables, and only ports 80/443 exposed via Caddy.</done>
</task>

<task type="auto">
  <name>Task 2: Create .dockerignore and update .env.example and .gitignore</name>
  <files>.dockerignore, .env.example, .gitignore</files>
  <action>
**Create `.dockerignore` at project root:**
```
.git
.venv
__pycache__
data/
*.pyc
.planning/
tests/
.env
.env.*
node_modules/
.next/
frontend/node_modules/
frontend/.next/
.pytest_cache/
*.egg-info/
```

This prevents large/sensitive files from entering the Docker build context. Without .dockerignore, `docker build` would send the entire directory (including data/, .venv/, node_modules/) to the Docker daemon, slowing builds dramatically.

**Update `.env.example`** to include Docker-specific variables. Keep existing vars and ADD these new sections:

```
# Docker Deployment
DOMAIN=localhost
AUTH_USERNAME=admin
AUTH_PASSWORD_HASH=

# To generate a password hash, run:
# docker run --rm caddy:2-alpine caddy hash-password --plaintext 'your-password'
# Then paste the output (starting with $2a$...) as AUTH_PASSWORD_HASH value

# Behind proxy (set to true when running behind Caddy in Docker)
DATAVISOR_BEHIND_PROXY=false
```

Keep ALL existing env vars from the current .env.example (DATAVISOR_DB_PATH, DATAVISOR_THUMBNAIL_CACHE_DIR, etc.). Append the Docker section.

**Update `.gitignore`** to add Docker-related ignores if not already present:
- Ensure `.env` is already ignored (it is)
- Add `caddy_data/` and `caddy_config/` if they could leak as local dirs
- No other changes needed -- the current .gitignore already covers .env and data/
  </action>
  <verify>Confirm .dockerignore exists and contains `.venv`, `data/`, `.git`. Confirm .env.example contains `AUTH_PASSWORD_HASH` and `DOMAIN`. Confirm .gitignore still contains `.env`.</verify>
  <done>.dockerignore excludes all non-essential files from Docker builds. .env.example documents all required environment variables including Docker-specific auth vars with instructions for generating password hash. .gitignore updated if needed.</done>
</task>

</tasks>

<verification>
1. `docker compose config` parses without YAML errors
2. `.dockerignore` exists and excludes `.venv`, `data/`, `.git`, `node_modules/`
3. `.env.example` contains `DOMAIN`, `AUTH_USERNAME`, `AUTH_PASSWORD_HASH`, and password hash generation instructions
4. `docker-compose.yml` has exactly 3 services: backend, frontend, caddy
5. Only caddy service has `ports` defined (80, 443)
6. Backend service has `stop_grace_period: 30s` and healthcheck
7. Backend volume mount is `./data:/app/data` (directory, not file)
</verification>

<success_criteria>
- docker-compose.yml orchestrates 3 services with correct networking and volumes
- Data persists across container restarts via ./data bind mount
- Auth credentials come from .env file (never hardcoded)
- .dockerignore prevents build context bloat
- Only Caddy exposes ports to the host
</success_criteria>

<output>
After completion, create `.planning/phases/08-docker-deployment-auth/08-03-SUMMARY.md`
</output>
