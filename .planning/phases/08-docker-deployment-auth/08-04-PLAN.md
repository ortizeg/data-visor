---
phase: 08-docker-deployment-auth
plan: 04
type: execute
wave: 3
depends_on: ["08-03"]
files_modified:
  - scripts/run-local.sh
  - scripts/deploy-gcp.sh
  - scripts/vm-startup.sh
autonomous: true

must_haves:
  truths:
    - "User can run scripts/run-local.sh and DataVisor starts via Docker Compose"
    - "User can run scripts/deploy-gcp.sh to provision a GCP VM with Docker and firewall rules"
    - "GCP VM auto-installs Docker, clones repo, and starts DataVisor on first boot"
  artifacts:
    - path: "scripts/run-local.sh"
      provides: "One-command local Docker Compose launcher"
      contains: "docker compose up"
    - path: "scripts/deploy-gcp.sh"
      provides: "GCP VM provisioning via gcloud CLI"
      contains: "gcloud compute instances create"
    - path: "scripts/vm-startup.sh"
      provides: "VM bootstrap script (Docker install, clone, start)"
      contains: "docker compose up"
  key_links:
    - from: "scripts/run-local.sh"
      to: "docker-compose.yml"
      via: "runs docker compose up"
      pattern: "docker compose up"
    - from: "scripts/deploy-gcp.sh"
      to: "scripts/vm-startup.sh"
      via: "passes startup script to VM via metadata"
      pattern: "metadata-from-file.*startup-script"
    - from: "scripts/vm-startup.sh"
      to: "docker-compose.yml"
      via: "clones repo and runs docker compose"
      pattern: "docker compose up"
---

<objective>
Create deployment scripts for local Docker and GCP cloud deployment.

Purpose: These scripts make deployment a single command -- `scripts/run-local.sh` for local Docker, `scripts/deploy-gcp.sh` for GCP VM provisioning. Without these, users would need to manually run multiple commands and configure services.
Output: scripts/run-local.sh, scripts/deploy-gcp.sh, scripts/vm-startup.sh
</objective>

<execution_context>
@/Users/ortizeg/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ortizeg/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-docker-deployment-auth/08-RESEARCH.md

@.planning/phases/08-docker-deployment-auth/08-03-SUMMARY.md

@docker-compose.yml
@.env.example
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create local run script</name>
  <files>scripts/run-local.sh</files>
  <action>
Create directory `scripts/` at project root if it does not exist.

Create `scripts/run-local.sh` with the following:

```bash
#!/usr/bin/env bash
# scripts/run-local.sh -- Start DataVisor locally via Docker Compose
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
PROJECT_DIR="$(dirname "$SCRIPT_DIR")"

cd "$PROJECT_DIR"

# Ensure data directory exists (for bind mount)
mkdir -p data

# Check for .env file
if [ ! -f .env ]; then
    echo "No .env file found. Creating from .env.example..."
    cp .env.example .env
    echo ""
    echo "IMPORTANT: You must set AUTH_PASSWORD_HASH in .env before running."
    echo ""
    echo "Generate a password hash with:"
    echo "  docker run --rm caddy:2-alpine caddy hash-password --plaintext 'your-password'"
    echo ""
    echo "Then edit .env and set AUTH_PASSWORD_HASH to the output."
    echo "After that, re-run this script."
    exit 1
fi

# Check that AUTH_PASSWORD_HASH is set (not empty)
if ! grep -q "^AUTH_PASSWORD_HASH=.\+" .env; then
    echo "ERROR: AUTH_PASSWORD_HASH is not set in .env"
    echo ""
    echo "Generate a password hash with:"
    echo "  docker run --rm caddy:2-alpine caddy hash-password --plaintext 'your-password'"
    echo ""
    echo "Then edit .env and set AUTH_PASSWORD_HASH to the output."
    exit 1
fi

echo "Starting DataVisor..."
docker compose up --build -d

echo ""
echo "DataVisor is running at http://localhost"
echo "Username: $(grep '^AUTH_USERNAME=' .env | cut -d= -f2)"
echo ""
echo "Stop with: docker compose down"
echo "View logs: docker compose logs -f"
```

Make the script executable: `chmod +x scripts/run-local.sh`
  </action>
  <verify>Confirm the file exists, is executable (`ls -la scripts/run-local.sh` shows `x` permission), and contains the expected commands. Run `bash -n scripts/run-local.sh` to syntax-check without executing.</verify>
  <done>scripts/run-local.sh exists, is executable, checks for .env and AUTH_PASSWORD_HASH, creates data directory, and runs docker compose up with user-friendly output.</done>
</task>

<task type="auto">
  <name>Task 2: Create GCP deployment and VM startup scripts</name>
  <files>scripts/deploy-gcp.sh, scripts/vm-startup.sh</files>
  <action>
**Create `scripts/deploy-gcp.sh`:**

```bash
#!/usr/bin/env bash
# scripts/deploy-gcp.sh -- Provision a GCP VM for DataVisor
set -euo pipefail

# Required environment variables
PROJECT_ID="${GCP_PROJECT_ID:?Set GCP_PROJECT_ID environment variable}"

# Configurable with defaults
ZONE="${GCP_ZONE:-us-central1-a}"
INSTANCE_NAME="${GCP_INSTANCE:-datavisor}"
MACHINE_TYPE="${GCP_MACHINE_TYPE:-e2-standard-4}"
DISK_SIZE="${GCP_DISK_SIZE:-50}"

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"

echo "Provisioning DataVisor VM..."
echo "  Project:  $PROJECT_ID"
echo "  Zone:     $ZONE"
echo "  Instance: $INSTANCE_NAME"
echo "  Machine:  $MACHINE_TYPE"
echo "  Disk:     ${DISK_SIZE}GB"
echo ""

# Create VM with Ubuntu 24.04 LTS
gcloud compute instances create "$INSTANCE_NAME" \
  --project="$PROJECT_ID" \
  --zone="$ZONE" \
  --machine-type="$MACHINE_TYPE" \
  --image-family=ubuntu-2404-lts-amd64 \
  --image-project=ubuntu-os-cloud \
  --boot-disk-size="${DISK_SIZE}GB" \
  --boot-disk-type=pd-balanced \
  --tags=http-server,https-server \
  --metadata-from-file=startup-script="$SCRIPT_DIR/vm-startup.sh"

echo ""

# Create firewall rules for HTTP/HTTPS (idempotent -- ignores if already exists)
gcloud compute firewall-rules create allow-http-https \
  --project="$PROJECT_ID" \
  --allow=tcp:80,tcp:443 \
  --target-tags=http-server,https-server \
  --source-ranges=0.0.0.0/0 \
  --description="Allow HTTP/HTTPS for DataVisor" \
  2>/dev/null || echo "Firewall rule 'allow-http-https' already exists (OK)"

# Get external IP
EXTERNAL_IP=$(gcloud compute instances describe "$INSTANCE_NAME" \
  --project="$PROJECT_ID" \
  --zone="$ZONE" \
  --format="get(networkInterfaces[0].accessConfigs[0].natIP)")

echo ""
echo "VM provisioned successfully!"
echo ""
echo "External IP: $EXTERNAL_IP"
echo ""
echo "NEXT STEPS:"
echo "1. Wait 3-5 minutes for the startup script to install Docker and build images"
echo "2. SSH into the VM to configure auth:"
echo "   gcloud compute ssh $INSTANCE_NAME --project=$PROJECT_ID --zone=$ZONE"
echo "3. On the VM, create .env file:"
echo "   cd /opt/data-visor"
echo "   cp .env.example .env"
echo "   # Generate password hash:"
echo "   docker run --rm caddy:2-alpine caddy hash-password --plaintext 'your-password'"
echo "   # Edit .env and set AUTH_PASSWORD_HASH, DOMAIN (if using custom domain)"
echo "   nano .env"
echo "4. Start DataVisor:"
echo "   docker compose up -d --build"
echo "5. Access at: http://$EXTERNAL_IP (or https://yourdomain.com if DOMAIN is set)"
```

**Create `scripts/vm-startup.sh`:**

```bash
#!/usr/bin/env bash
# scripts/vm-startup.sh -- GCP VM startup script
# This runs automatically on first boot via instance metadata
set -euo pipefail

export DEBIAN_FRONTEND=noninteractive

# Install Docker and Docker Compose plugin
apt-get update
apt-get install -y docker.io docker-compose-plugin git

# Enable Docker to start on boot
systemctl enable docker
systemctl start docker

# Clone repository
cd /opt
if [ ! -d data-visor ]; then
    git clone https://github.com/YOUR_USER/data-visor.git
fi
cd data-visor

# Create data directory
mkdir -p data

# NOTE: .env must be created manually (contains secrets)
# The deploy-gcp.sh script prints instructions for this step
echo "DataVisor VM setup complete. Create .env and run: docker compose up -d --build"
```

Make both scripts executable: `chmod +x scripts/deploy-gcp.sh scripts/vm-startup.sh`

NOTE on `vm-startup.sh`: The `YOUR_USER` placeholder in the git clone URL is intentional. The deployment docs (Plan 05) will instruct the user to update this with their actual GitHub username or use a different clone method. The startup script does NOT automatically start docker compose because the .env file with auth credentials must be created first.
  </action>
  <verify>Confirm both files exist and are executable. Run `bash -n scripts/deploy-gcp.sh` and `bash -n scripts/vm-startup.sh` to syntax-check without executing. Verify deploy-gcp.sh references vm-startup.sh via metadata-from-file.</verify>
  <done>scripts/deploy-gcp.sh provisions a GCP VM with Ubuntu 24.04, firewall rules for HTTP/HTTPS, and prints next-step instructions. scripts/vm-startup.sh installs Docker and clones the repo on first boot. Both are executable and syntax-valid.</done>
</task>

</tasks>

<verification>
1. `scripts/run-local.sh` exists and is executable
2. `scripts/deploy-gcp.sh` exists and is executable
3. `scripts/vm-startup.sh` exists and is executable
4. `bash -n scripts/run-local.sh` passes syntax check
5. `bash -n scripts/deploy-gcp.sh` passes syntax check
6. `bash -n scripts/vm-startup.sh` passes syntax check
7. deploy-gcp.sh contains `gcloud compute instances create` and `metadata-from-file`
8. vm-startup.sh contains `docker.io`, `docker-compose-plugin`, `git clone`
</verification>

<success_criteria>
- Local run script validates .env, creates data dir, and starts Docker Compose with a single command
- GCP script provisions VM with correct image, disk, firewall, and prints actionable next steps
- VM startup script installs Docker + Compose + git and clones the repo
- All scripts are executable and pass bash syntax validation
</success_criteria>

<output>
After completion, create `.planning/phases/08-docker-deployment-auth/08-04-SUMMARY.md`
</output>
