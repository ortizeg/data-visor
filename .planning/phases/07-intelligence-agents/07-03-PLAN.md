---
phase: 07-intelligence-agents
plan: 03
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - frontend/src/types/agent.ts
  - frontend/src/hooks/use-agent-analysis.ts
  - frontend/src/components/stats/intelligence-panel.tsx
  - frontend/src/components/stats/stats-dashboard.tsx
autonomous: true

must_haves:
  truths:
    - "User can trigger AI error analysis from an 'Intelligence' sub-tab in the Statistics dashboard"
    - "Analysis results display detected patterns with severity badges and supporting evidence"
    - "Recommendations display with priority, category, and actionable text"
    - "Loading state shows while agent is running (may take 10-30s)"
    - "Error state shows clear message when API key is not configured (503 from backend)"
  artifacts:
    - path: "frontend/src/types/agent.ts"
      provides: "AnalysisReport, PatternInsight, Recommendation TypeScript types"
      contains: "AnalysisReport"
    - path: "frontend/src/hooks/use-agent-analysis.ts"
      provides: "useMutation hook for POST /analyze"
      contains: "useAgentAnalysis"
    - path: "frontend/src/components/stats/intelligence-panel.tsx"
      provides: "Intelligence panel with analyze button, patterns list, recommendations list"
      contains: "IntelligencePanel"
    - path: "frontend/src/components/stats/stats-dashboard.tsx"
      provides: "Updated stats dashboard with 'Intelligence' sub-tab"
      contains: "intelligence"
  key_links:
    - from: "frontend/src/components/stats/intelligence-panel.tsx"
      to: "frontend/src/hooks/use-agent-analysis.ts"
      via: "useAgentAnalysis mutation hook"
      pattern: "useAgentAnalysis"
    - from: "frontend/src/components/stats/stats-dashboard.tsx"
      to: "frontend/src/components/stats/intelligence-panel.tsx"
      via: "IntelligencePanel rendered in intelligence sub-tab"
      pattern: "IntelligencePanel"
    - from: "frontend/src/hooks/use-agent-analysis.ts"
      to: "app/routers/agent.py"
      via: "POST /datasets/{id}/analyze"
      pattern: "analyze"
---

<objective>
Build the frontend Intelligence panel that allows users to trigger AI-powered error analysis and view structured results (patterns + recommendations) within the Statistics dashboard.

Purpose: Delivers the user-facing UI for AGENT-01 (pattern detection) and AGENT-02 (action recommendations). Users see actionable insights derived from their prediction errors.
Output: New "Intelligence" sub-tab in the Statistics dashboard with an analyze button, pattern cards, and recommendation cards.
</objective>

<execution_context>
@/Users/ortizeg/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ortizeg/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-intelligence-agents/07-RESEARCH.md
@.planning/phases/07-intelligence-agents/07-01-SUMMARY.md

@frontend/src/components/stats/stats-dashboard.tsx
@frontend/src/hooks/use-error-analysis.ts
@frontend/src/stores/ui-store.ts
@app/models/agent.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create agent types, hook, and Intelligence panel component</name>
  <files>
    frontend/src/types/agent.ts
    frontend/src/hooks/use-agent-analysis.ts
    frontend/src/components/stats/intelligence-panel.tsx
  </files>
  <action>
    1. Create `frontend/src/types/agent.ts`:
       ```typescript
       export interface PatternInsight {
         pattern: string;
         evidence: string;
         severity: "high" | "medium" | "low";
         affected_classes: string[];
       }

       export interface Recommendation {
         action: string;
         rationale: string;
         priority: "high" | "medium" | "low";
         category: "data_collection" | "augmentation" | "labeling" | "architecture" | "hyperparameter";
       }

       export interface AnalysisReport {
         patterns: PatternInsight[];
         recommendations: Recommendation[];
         summary: string;
       }

       export interface AnalysisRequest {
         source?: string;
         iou_threshold?: number;
         conf_threshold?: number;
       }
       ```

    2. Create `frontend/src/hooks/use-agent-analysis.ts`:
       - Use `useMutation` from TanStack Query (not useQuery -- analysis is on-demand, not auto-fetched)
       - Mutation function: POST to `/datasets/${datasetId}/analyze` with JSON body (AnalysisRequest)
       - Use `apiFetch` with method: "POST" and body
       - Return the mutation object (mutate, data, isPending, error, reset)
       ```typescript
       export function useAgentAnalysis(datasetId: string) {
         return useMutation({
           mutationFn: (params: AnalysisRequest = {}) =>
             apiFetch<AnalysisReport>(`/datasets/${datasetId}/analyze`, {
               method: "POST",
               headers: { "Content-Type": "application/json" },
               body: JSON.stringify({
                 source: params.source ?? "prediction",
                 iou_threshold: params.iou_threshold ?? 0.5,
                 conf_threshold: params.conf_threshold ?? 0.25,
               }),
             }),
         });
       }
       ```
       NOTE: Check how apiFetch is used elsewhere. If it uses query params instead of JSON body, adapt accordingly. The backend POST endpoint should accept either JSON body or query params.

    3. Create `frontend/src/components/stats/intelligence-panel.tsx`:
       Component: `IntelligencePanel({ datasetId }: { datasetId: string })`

       - Use `useAgentAnalysis(datasetId)` hook
       - State: `report` (AnalysisReport | null) to persist the last result

       Layout (three sections):

       **Header section:**
       - Title: "AI Error Analysis"
       - Description: "Use an AI agent to analyze prediction error patterns and recommend corrective actions."
       - "Analyze" button: onClick calls `mutation.mutate({})`. Disabled while isPending.
       - When isPending: Show spinner or "Analyzing..." text (agent may take 10-30s)

       **When error (mutation.error):**
       - If error message contains "503" or "API key": Show info box: "To use AI analysis, configure DATAVISOR_AGENT_MODEL and your API key (OPENAI_API_KEY or ANTHROPIC_API_KEY) in the .env file."
       - Otherwise: generic error display

       **When data is available (report):**

       a. **Summary card:**
          - Light background card displaying `report.summary` text

       b. **Patterns section:**
          - Heading: "Detected Patterns" with count badge
          - List of pattern cards, each showing:
            - Severity badge (high=red, medium=amber, low=zinc)
            - Pattern text (main insight)
            - Evidence text (supporting data, smaller/muted)
            - Affected classes as small pills/tags

       c. **Recommendations section:**
          - Heading: "Recommendations" with count badge
          - List of recommendation cards, each showing:
            - Priority badge (high=red, medium=amber, low=zinc)
            - Category badge (data_collection, augmentation, labeling, architecture, hyperparameter) with distinct colors
            - Action text (main recommendation, bold)
            - Rationale text (explanation, smaller/muted)

       Styling: Use existing Tailwind patterns from the project:
       - Cards: `rounded-lg border border-zinc-200 dark:border-zinc-700 p-4 bg-white dark:bg-zinc-900`
       - Headings: `text-sm font-semibold text-zinc-700 dark:text-zinc-300`
       - Badge colors for severity/priority:
         - high: `bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-400`
         - medium: `bg-amber-100 text-amber-700 dark:bg-amber-900/30 dark:text-amber-400`
         - low: `bg-zinc-100 text-zinc-600 dark:bg-zinc-700 dark:text-zinc-400`
       - Category badges: use muted colored backgrounds
  </action>
  <verify>
    ```bash
    cd /Users/ortizeg/1Projects/⛹️‍♂️\ Next\ Play/code/data-visor/frontend
    npx tsc --noEmit 2>&1 | head -30
    ```
    TypeScript compilation should succeed with no errors related to agent types, hook, or intelligence panel.
  </verify>
  <done>
    - TypeScript types match backend AnalysisReport schema
    - useMutation hook calls POST /analyze with correct parameters
    - IntelligencePanel renders analyze button, loading state, error state, and structured results
    - Severity and priority badges use consistent color scheme
    - 503 error shows helpful configuration message
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Intelligence sub-tab to Statistics dashboard</name>
  <files>
    frontend/src/components/stats/stats-dashboard.tsx
  </files>
  <action>
    1. Update `frontend/src/components/stats/stats-dashboard.tsx`:

       - Import `IntelligencePanel` from `@/components/stats/intelligence-panel`

       - Extend the `SubTab` type to include "intelligence":
         ```typescript
         type SubTab = "overview" | "evaluation" | "error_analysis" | "intelligence";
         ```

       - Add an "Intelligence" tab button in the sub-tab navigation bar, after the "Error Analysis" button:
         ```tsx
         <button
           onClick={() => setActiveTab("intelligence")}
           disabled={!hasPredictions}
           className={`px-4 py-2 text-sm font-medium border-b-2 transition-colors ${
             activeTab === "intelligence"
               ? "border-purple-500 text-purple-600 dark:text-purple-400"
               : "border-transparent text-zinc-500 dark:text-zinc-400 hover:text-zinc-700 dark:hover:text-zinc-300"
           } disabled:opacity-40 disabled:cursor-not-allowed`}
         >
           Intelligence
         </button>
         ```
         NOTE: Use purple as the accent color for the Intelligence tab to visually distinguish it from the blue-accented Overview/Evaluation/Error Analysis tabs. This signals it's an AI-powered feature.

       - Add the intelligence panel rendering at the bottom of the component, alongside the other tab panels:
         ```tsx
         {activeTab === "intelligence" && hasPredictions && (
           <IntelligencePanel datasetId={datasetId} />
         )}
         ```

       - The Intelligence tab should be disabled when there are no predictions (same as Evaluation and Error Analysis tabs), since the agent analyzes prediction errors.
  </action>
  <verify>
    ```bash
    cd /Users/ortizeg/1Projects/⛹️‍♂️\ Next\ Play/code/data-visor/frontend
    npx tsc --noEmit 2>&1 | head -30
    ```
    TypeScript compiles. Also visually verify: the Statistics dashboard now shows 4 sub-tabs (Overview, Evaluation, Error Analysis, Intelligence).
  </verify>
  <done>
    - Statistics dashboard has 4 sub-tabs including "Intelligence" with purple accent
    - Intelligence tab is disabled when no predictions exist
    - Clicking Intelligence tab renders the IntelligencePanel component
    - No changes to existing Overview, Evaluation, or Error Analysis tab behavior
  </done>
</task>

</tasks>

<verification>
1. `cd frontend && npx tsc --noEmit` -- no TypeScript errors
2. Start frontend: Navigate to dataset page, click Statistics tab
3. Statistics dashboard shows 4 sub-tabs: Overview, Evaluation, Error Analysis, Intelligence
4. Click Intelligence tab: "Analyze" button appears
5. Click Analyze (with API key configured): Agent runs, results display with patterns and recommendations
6. Click Analyze (without API key): Clear configuration error message shown
</verification>

<success_criteria>
- Intelligence sub-tab visible in Statistics dashboard when predictions exist
- Analyze button triggers POST /analyze and shows loading spinner during execution
- Results display patterns with severity badges and recommendations with priority/category badges
- Missing API key shows helpful configuration instructions (not a crash)
- TypeScript compiles cleanly with no errors
</success_criteria>

<output>
After completion, create `.planning/phases/07-intelligence-agents/07-03-SUMMARY.md`
</output>
