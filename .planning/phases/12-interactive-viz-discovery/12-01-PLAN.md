---
phase: 12-interactive-viz-discovery
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/src/stores/filter-store.ts
  - frontend/src/hooks/use-samples.ts
  - frontend/src/components/detail/sample-modal.tsx
  - frontend/src/components/stats/class-distribution.tsx
  - frontend/src/components/stats/stats-dashboard.tsx
  - frontend/src/components/grid/discovery-filter-chip.tsx
autonomous: true

must_haves:
  truths:
    - "Clicking 'Find Similar' on a sample in the detail modal filters the main grid to show nearest neighbors"
    - "Clicking a bar in the class distribution chart sets the category filter and switches to the grid tab"
    - "A visible chip/badge indicates when a discovery filter is active, and clicking it clears the filter"
  artifacts:
    - path: "frontend/src/stores/filter-store.ts"
      provides: "sampleIdFilter state + setSampleIdFilter + clearSampleIdFilter actions"
      contains: "sampleIdFilter"
    - path: "frontend/src/hooks/use-samples.ts"
      provides: "Merges sampleIdFilter into sample_ids query parameter"
      contains: "sampleIdFilter"
    - path: "frontend/src/components/grid/discovery-filter-chip.tsx"
      provides: "Visual indicator when discovery filter is active with clear button"
      exports: ["DiscoveryFilterChip"]
    - path: "frontend/src/components/detail/sample-modal.tsx"
      provides: "Find Similar button that filters grid via sampleIdFilter"
      contains: "setSampleIdFilter"
    - path: "frontend/src/components/stats/class-distribution.tsx"
      provides: "onClick handler on Bar components that sets category filter"
      contains: "onClick"
  key_links:
    - from: "frontend/src/stores/filter-store.ts"
      to: "frontend/src/hooks/use-samples.ts"
      via: "sampleIdFilter selector"
      pattern: "useFilterStore.*sampleIdFilter"
    - from: "frontend/src/components/detail/sample-modal.tsx"
      to: "frontend/src/stores/filter-store.ts"
      via: "setSampleIdFilter call after similarity search"
      pattern: "setSampleIdFilter"
    - from: "frontend/src/components/stats/class-distribution.tsx"
      to: "frontend/src/stores/filter-store.ts"
      via: "setCategory call on bar click"
      pattern: "setCategory.*category_name"
---

<objective>
Add the discovery filter foundation to filter-store and use-samples, wire "Find Similar" to filter the grid, and make histogram bars interactive.

Purpose: Establishes the shared `sampleIdFilter` mechanism that all four Phase 12 discovery features pipe through, then implements two of the four features (ANNOT-06 find-similar grid filtering and TRIAGE-06 interactive histograms).

Output: Users can click "Find Similar" in the detail modal to see neighbors in the grid, click class distribution bars to filter by category, and see a chip when discovery filters are active.
</objective>

<execution_context>
@/Users/ortizeg/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ortizeg/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-interactive-viz-discovery/12-RESEARCH.md

@frontend/src/stores/filter-store.ts
@frontend/src/stores/ui-store.ts
@frontend/src/stores/embedding-store.ts
@frontend/src/hooks/use-samples.ts
@frontend/src/hooks/use-similarity.ts
@frontend/src/components/detail/sample-modal.tsx
@frontend/src/components/stats/class-distribution.tsx
@frontend/src/components/stats/stats-dashboard.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add sampleIdFilter to filter-store and wire into use-samples</name>
  <files>
    frontend/src/stores/filter-store.ts
    frontend/src/hooks/use-samples.ts
    frontend/src/components/grid/discovery-filter-chip.tsx
  </files>
  <action>
    1. In `filter-store.ts`, add to the `FilterState` interface:
       - `sampleIdFilter: string[] | null` -- sample IDs from discovery actions (find-similar, confusion cell click, near-dupes). null = no filter active.
       - `setSampleIdFilter: (ids: string[] | null) => void`
       - `clearSampleIdFilter: () => void`

    2. Add `sampleIdFilter: null` to `DEFAULT_FILTERS`.

    3. Add the setter implementations:
       - `setSampleIdFilter: (ids) => set({ sampleIdFilter: ids })`
       - `clearSampleIdFilter: () => set({ sampleIdFilter: null })`

    4. Update `clearFilters` to also clear `sampleIdFilter: null`.

    5. Add atomic selectors:
       - `export const useSampleIdFilter = () => useFilterStore((s) => s.sampleIdFilter);`

    6. Update `useActiveFilterCount` to count sampleIdFilter as active when non-null.

    7. In `use-samples.ts`:
       - Import `useSampleIdFilter` from filter-store (or read directly from useFilterStore).
       - Read `sampleIdFilter` alongside `lassoSelectedIds`.
       - Merge: `const effectiveIds = lassoSelectedIds ?? sampleIdFilter;` -- lasso takes priority when both are active.
       - Include `sampleIdFilter` in the queryKey array so changes trigger refetch.
       - The existing `sample_ids` param logic already handles the array-to-CSV conversion; just feed it the merged `effectiveIds` instead of raw `lassoSelectedIds`.

    8. Create `frontend/src/components/grid/discovery-filter-chip.tsx`:
       - A small component that shows when `sampleIdFilter` is non-null.
       - Displays: "Discovery filter: {N} samples" with an X button to clear.
       - Clicking X calls `clearSampleIdFilter()`.
       - Style: rounded pill with blue-50 bg, blue-600 text, hover blue-100, similar to existing filter pills.
       - Export as `DiscoveryFilterChip`.

    9. Wire the `DiscoveryFilterChip` into the dataset page. Find the grid section (likely in the dataset `[datasetId]/page.tsx`) and render the chip above the grid when `sampleIdFilter` is non-null. If the grid section is hard to identify, place it inside `stats-dashboard.tsx` at the top or in the main page layout. The chip should be visible regardless of which tab is active so the user always knows a filter is applied.
  </action>
  <verify>
    TypeScript compiles: `cd frontend && npx tsc --noEmit` passes.
    The filter-store exports `useSampleIdFilter`.
    The use-samples hook reads sampleIdFilter and includes it in queryKey.
  </verify>
  <done>
    filter-store has sampleIdFilter state. use-samples merges sampleIdFilter into sample_ids query param. DiscoveryFilterChip renders when filter is active. clearFilters also clears the discovery filter.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire Find Similar to grid filter + make histogram bars clickable</name>
  <files>
    frontend/src/components/detail/sample-modal.tsx
    frontend/src/components/stats/class-distribution.tsx
    frontend/src/components/stats/stats-dashboard.tsx
  </files>
  <action>
    **Find Similar -> Grid (ANNOT-06):**

    1. In `sample-modal.tsx`, add a second button next to the existing "Find Similar" / "Hide Similar" toggle. The new button should say "Find Similar in Grid" (or change the existing behavior -- research recommends extending the existing button to ALSO filter the grid).

    Recommended approach: Keep the existing "Find Similar" button as-is (shows similarity panel below). Add a NEW button "Show in Grid" that:
    - Fetches similarity results using the existing `useSimilarity` hook data (if already loaded) or triggers a fetch.
    - Extracts the `sample_id` array from results.
    - Calls `useFilterStore.getState().setSampleIdFilter(ids)` with the IDs.
    - Calls `useUIStore.getState().setActiveTab("grid")` to switch to grid.
    - Calls `useUIStore.getState().closeDetailModal()` to close the modal.

    This "Show in Grid" button should only appear when similarity results are already loaded (i.e., after user clicks "Find Similar" and results come back). It appears next to "Hide Similar".

    2. Import `useFilterStore` in sample-modal.tsx for the `setSampleIdFilter` call.

    **Interactive Histograms (TRIAGE-06):**

    3. In `class-distribution.tsx`:
       - Add `onClick` handler to both `<Bar>` components (GT and Predictions bars).
       - The onClick handler receives the data entry object. Extract `data.category_name`.
       - Call `useFilterStore.getState().setCategory(data.category_name)` to set the category filter.
       - Call `useUIStore.getState().setActiveTab("grid")` to switch to grid tab.
       - Add `className="cursor-pointer"` to both `<Bar>` elements to indicate clickability.
       - Import `useFilterStore` and `useUIStore` at the top.

    4. In `stats-dashboard.tsx`, add a subtle hint below the class distribution section: a small text like "(click any bar to filter grid)" in zinc-400 text. This is optional polish.

    Note on Recharts onClick: The `onClick` prop on `<Bar>` receives `(data, index)` where `data` is the full entry object from the `data` array. Since the data array items have `category_name` property, `data.category_name` gives the clicked class name. The layout is "vertical" so the category axis is Y -- this does not affect the data object shape.
  </action>
  <verify>
    TypeScript compiles: `cd frontend && npx tsc --noEmit` passes.
    In sample-modal.tsx, the "Show in Grid" button calls setSampleIdFilter.
    In class-distribution.tsx, Bar components have onClick handlers.
  </verify>
  <done>
    "Find Similar" in sample modal can now pipe results to the grid via sampleIdFilter. Clicking a class distribution bar sets category filter and switches to grid tab. Both features use the discovery filter pattern established in Task 1.
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles without errors: `cd frontend && npx tsc --noEmit`
2. Dev server starts: `cd frontend && npm run dev` (no runtime errors)
3. filter-store exports: sampleIdFilter, setSampleIdFilter, clearSampleIdFilter, useSampleIdFilter
4. use-samples.ts queryKey includes sampleIdFilter
5. class-distribution Bar components have onClick props
6. sample-modal has "Show in Grid" button that calls setSampleIdFilter
7. DiscoveryFilterChip appears when sampleIdFilter is non-null
</verification>

<success_criteria>
- ANNOT-06: "Find Similar" button in detail modal can filter the main grid to nearest neighbors (via "Show in Grid" action)
- TRIAGE-06 (partial): Class distribution histogram bars are clickable and filter the grid by category
- Discovery filter chip shows active filter count and allows clearing
- All four Phase 12 features can use sampleIdFilter as their shared output mechanism
</success_criteria>

<output>
After completion, create `.planning/phases/12-interactive-viz-discovery/12-01-SUMMARY.md`
</output>
