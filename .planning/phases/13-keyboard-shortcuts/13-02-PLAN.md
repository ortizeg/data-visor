---
phase: 13-keyboard-shortcuts
plan: 02
type: execute
wave: 2
depends_on: ["13-01"]
files_modified:
  - frontend/src/components/detail/sample-modal.tsx
  - frontend/src/components/toolbar/shortcut-help-overlay.tsx
  - frontend/src/app/datasets/[datasetId]/page.tsx
autonomous: true

must_haves:
  truths:
    - "j/ArrowRight and k/ArrowLeft navigate to next/previous sample while modal is open"
    - "Number keys 1-4 set triage tags (TP, FP, FN, Mistake) on the current sample in the modal"
    - "Pressing the same number key on an already-tagged sample removes the triage tag"
    - "h toggles highlight mode while modal is open"
    - "e toggles edit mode while modal is open"
    - "Delete/Backspace deletes the selected annotation when in edit mode"
    - "Ctrl+Z / Cmd+Z undoes the last annotation delete or edit"
    - "Escape exits edit mode (does NOT close modal -- native dialog handles that)"
    - "? (shift+/) opens a help overlay listing all keyboard shortcuts"
    - "Escape closes the help overlay"
    - "Shortcuts do not fire when typing in text inputs"
  artifacts:
    - path: "frontend/src/components/detail/sample-modal.tsx"
      provides: "Modal-scope keyboard shortcuts for navigation, triage, editing"
      contains: "useHotkeys"
    - path: "frontend/src/components/toolbar/shortcut-help-overlay.tsx"
      provides: "Full-screen overlay listing all shortcuts grouped by category"
      exports: ["ShortcutHelpOverlay"]
    - path: "frontend/src/app/datasets/[datasetId]/page.tsx"
      provides: "Mounts ShortcutHelpOverlay at page level"
      contains: "ShortcutHelpOverlay"
  key_links:
    - from: "frontend/src/components/detail/sample-modal.tsx"
      to: "frontend/src/hooks/use-triage.ts"
      via: "useHotkeys 1-4 callbacks call setTriageTag/removeTriageTag mutations"
      pattern: "useHotkeys.*[1-4]"
    - from: "frontend/src/components/detail/sample-modal.tsx"
      to: "frontend/src/hooks/use-annotations.ts"
      via: "useHotkeys Delete callback calls deleteMutation"
      pattern: "useHotkeys.*Delete"
    - from: "frontend/src/components/toolbar/shortcut-help-overlay.tsx"
      to: "frontend/src/lib/shortcuts.ts"
      via: "imports SHORTCUTS array and groups by category for display"
      pattern: "import.*SHORTCUTS.*from.*shortcuts"
    - from: "frontend/src/components/toolbar/shortcut-help-overlay.tsx"
      to: "frontend/src/stores/ui-store.ts"
      via: "reads isHelpOverlayOpen, calls toggleHelpOverlay"
      pattern: "useUIStore.*isHelpOverlayOpen"
---

<objective>
Wire all modal-scope keyboard shortcuts (navigation, triage, editing with undo) and create the help overlay component.

Purpose: Delivers the remaining three requirements (UX-02 triage, UX-03 editing, UX-04 help overlay) plus the modal portion of UX-01 navigation. After this plan, all keyboard shortcuts are functional.

Output: Modal navigation via j/k, triage via 1-4 and h, edit mode via e, annotation delete via Delete/Backspace, undo via Ctrl+Z, and a ? help overlay showing all shortcuts.
</objective>

<execution_context>
@/Users/ortizeg/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ortizeg/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-keyboard-shortcuts/13-RESEARCH.md
@.planning/phases/13-keyboard-shortcuts/13-01-SUMMARY.md
@frontend/src/components/detail/sample-modal.tsx
@frontend/src/components/triage/triage-tag-buttons.tsx
@frontend/src/hooks/use-triage.ts
@frontend/src/hooks/use-annotations.ts
@frontend/src/types/triage.ts
@frontend/src/stores/ui-store.ts
@frontend/src/lib/shortcuts.ts
@frontend/src/app/datasets/[datasetId]/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Modal navigation and triage shortcuts</name>
  <files>
    frontend/src/components/detail/sample-modal.tsx
  </files>
  <action>
Add useHotkeys calls to `SampleModal` for modal-scope shortcuts. Import `useHotkeys` from `react-hotkeys-hook` and `TRIAGE_OPTIONS` from `@/types/triage`.

**Navigation (j/k in modal):**
- `'j, ArrowRight'`: find current sample index in `samples` array, if not at end, call `openDetailModal(samples[idx + 1].id)`. Enabled when `isDetailModalOpen`. Pass `{ enabled: isDetailModalOpen, preventDefault: true }` and deps `[selectedSampleId, samples]`.
- `'k, ArrowLeft'`: same but navigate to previous. Clamp at index 0.

**Triage (1-4 number keys):**
- For each TRIAGE_OPTIONS entry (index i), register `useHotkeys(String(i + 1), callback)`.
- Callback logic: find the active triage tag on the current sample (`sample.tags?.find(t => t.startsWith('triage:'))`). If active tag matches this option's tag, call `removeTriageTag.mutate(...)` to toggle off. Otherwise call `setTriageTag.mutate(...)` to set/replace.
- Enabled: `isDetailModalOpen && !isEditMode` (do NOT allow triage tagging during edit mode -- confusing UX per Pitfall 4 from research).
- Deps: `[sample, datasetId]`.
- NOTE: The component already has `TriageTagButtons` rendered. The triage hooks (`useSetTriageTag`, `useRemoveTriageTag`) must be called at the component level (not inside TriageTagButtons). Add these hooks to SampleModal directly.

**Highlight toggle (h):**
- `useHotkeys('h', () => toggleHighlightMode(), { enabled: isDetailModalOpen })` -- no deps needed, toggleHighlightMode is stable from Zustand.

**Edit mode toggle (e):**
- `useHotkeys('e', () => toggleEditMode(), { enabled: isDetailModalOpen })` -- toggles edit mode on/off.

IMPORTANT per Pitfall 2: Do NOT register a useHotkeys('Escape') for closing the modal. The native `<dialog>` element already handles Escape via its `onClose` handler which calls `closeDetailModal()`. Only use Escape for exiting edit mode (Task 2).
  </action>
  <verify>
    - `cd frontend && npx tsc --noEmit` passes
    - Open a dataset, click a sample to open modal. Press j -> navigates to next sample. Press k -> navigates to previous.
    - Press 1 -> TP tag appears on sample. Press 1 again -> tag removed. Press 2 -> FP tag set.
    - Press h -> highlight mode toggles. Press e -> edit mode toggles.
  </verify>
  <done>
    Modal supports j/k sample navigation, 1-4 triage tagging (toggle on/off), h highlight toggle, and e edit mode toggle via keyboard.
  </done>
</task>

<task type="auto">
  <name>Task 2: Annotation delete, undo stack, and Escape-from-edit-mode</name>
  <files>
    frontend/src/components/detail/sample-modal.tsx
  </files>
  <action>
Add remaining edit-mode keyboard shortcuts to SampleModal.

**Delete annotation (Delete/Backspace):**
- `useHotkeys('Delete, Backspace', callback, { enabled: isDetailModalOpen && isEditMode }, [selectedAnnotationId])`
- Callback: if `selectedAnnotationId` is not null, save undo state (see below), then call `deleteMutation.mutate(selectedAnnotationId)`, then `setSelectedAnnotationId(null)`.
- The `selectedAnnotationId` and `setSelectedAnnotationId` are already available from useUIStore in this component.
- The `deleteMutation` is already available (useDeleteAnnotation hook).

**Undo stack (Ctrl+Z / Cmd+Z):**
Implement a simple last-action undo using React state:

```typescript
interface UndoAction {
  type: 'delete';
  annotation: Annotation;  // The full annotation that was deleted
}

const [lastAction, setLastAction] = useState<UndoAction | null>(null);
```

- Before calling `deleteMutation.mutate(id)`, find the annotation from `annotations` (already fetched), and store it: `setLastAction({ type: 'delete', annotation: foundAnnotation })`.
- Reset `lastAction` to null when `selectedSampleId` changes (useEffect).
- Register: `useHotkeys('ctrl+z, meta+z', callback, { enabled: isDetailModalOpen && isEditMode && lastAction !== null }, [lastAction, datasetId, selectedSampleId])`
- Callback: if `lastAction.type === 'delete'`, call `createMutation.mutate({ dataset_id: datasetId, sample_id: lastAction.annotation.sample_id, category_name: lastAction.annotation.category_name, bbox_x: lastAction.annotation.bbox_x, bbox_y: lastAction.annotation.bbox_y, bbox_w: lastAction.annotation.bbox_w, bbox_h: lastAction.annotation.bbox_h })`. Then `setLastAction(null)`.
- This gives single-level undo for deletes only (the most destructive action). Move/resize undo is not implemented for v1 -- the user can manually adjust back.

**Escape from edit mode:**
- `useHotkeys('Escape', () => toggleEditMode(), { enabled: isDetailModalOpen && isEditMode })`
- This ONLY fires when edit mode is active. When edit mode is off, the native dialog Escape handling closes the modal. This avoids the double-fire issue from Pitfall 2.
- Do NOT use `preventDefault` here -- let the event bubble if edit mode is off.

IMPORTANT: The `enabled` option on the Escape handler is critical. When `isEditMode` is false, this handler is disabled, so pressing Escape falls through to the native dialog close behavior. When `isEditMode` is true, this handler fires first and toggles edit mode off; the user must press Escape again to close the modal.
  </action>
  <verify>
    - `cd frontend && npx tsc --noEmit` passes
    - Open modal, press e to enter edit mode. Click an annotation to select it. Press Delete -> annotation deleted. Press Ctrl+Z -> annotation restored.
    - Press Escape while in edit mode -> exits edit mode (modal stays open). Press Escape again -> modal closes.
    - Undo state resets when navigating to a different sample.
  </verify>
  <done>
    Delete/Backspace deletes selected annotation in edit mode. Ctrl+Z/Cmd+Z undoes the last delete (single level). Escape exits edit mode without closing modal. Undo state resets on sample change.
  </done>
</task>

<task type="auto">
  <name>Task 3: Help overlay component and page-level mounting</name>
  <files>
    frontend/src/components/toolbar/shortcut-help-overlay.tsx
    frontend/src/app/datasets/[datasetId]/page.tsx
  </files>
  <action>
1. Create `frontend/src/components/toolbar/shortcut-help-overlay.tsx`:

   - Import `useHotkeys` from react-hotkeys-hook, `SHORTCUTS` from `@/lib/shortcuts`, `useUIStore` from `@/stores/ui-store`.
   - Read `isHelpOverlayOpen` and `toggleHelpOverlay` from useUIStore.
   - Register `useHotkeys('shift+/', () => toggleHelp(), { preventDefault: true })` -- this is the ? key. Do NOT use `enableOnFormTags` unless the user is typing in an input where ? would be natural (it wouldn't -- the help shortcut should work everywhere).
   - Register `useHotkeys('Escape', () => { if (isOpen) toggleHelp(); }, { enabled: isOpen })` -- close overlay on Escape.
   - If `!isOpen`, return null (component renders nothing).
   - When open, render a fixed overlay:
     - `fixed inset-0 z-50` backdrop with `bg-black/50`, click to close
     - Centered card: `max-w-lg max-h-[80vh] overflow-auto rounded-xl bg-white dark:bg-zinc-900 p-6 shadow-2xl`
     - Click on card stops propagation (so clicking inside doesn't close)
     - Title: "Keyboard Shortcuts" (h2, text-lg font-semibold)
     - Group shortcuts by `group` field. Use a simple reduce to group (do NOT use Object.groupBy -- TypeScript may not have es2024 lib configured, per Open Question 3 from research).
     - For each group, render group name (capitalized, text-sm font-medium text-zinc-500 mb-2) then each shortcut as a row: label on left (text-sm text-zinc-700 dark:text-zinc-300), kbd badge on right (rounded bg-zinc-100 dark:bg-zinc-800 px-2 py-0.5 text-xs font-mono).
   - Export as named export: `export function ShortcutHelpOverlay()`

2. Mount in `frontend/src/app/datasets/[datasetId]/page.tsx`:
   - Import `ShortcutHelpOverlay` from `@/components/toolbar/shortcut-help-overlay`
   - Add `<ShortcutHelpOverlay />` as the last child inside the root `<div>`, after `<PredictionImportDialog>`. This ensures the overlay renders at page level with z-50 on top of everything.
  </action>
  <verify>
    - `cd frontend && npx tsc --noEmit` passes
    - `cd frontend && npm run build` completes without errors
    - Press ? on any dataset page -> help overlay appears with all shortcuts grouped by navigation/triage/editing/general
    - Press Escape or click backdrop -> overlay closes
    - Verify all 16 shortcuts are listed with correct display keys and labels
  </verify>
  <done>
    Help overlay shows all keyboard shortcuts grouped by category. Triggered by ? (shift+/), dismissed by Escape or backdrop click. Mounted at page level with z-50 stacking.
  </done>
</task>

</tasks>

<verification>
- `cd frontend && npx tsc --noEmit` passes
- `cd frontend && npm run build` completes
- All keyboard shortcuts functional:
  - Grid: j/k/arrows navigate, Enter opens modal
  - Modal: j/k navigate samples, 1-4 triage tag, h highlight, e edit mode
  - Edit mode: Delete/Backspace deletes annotation, Ctrl+Z undoes delete, Escape exits edit mode
  - Global: ? opens help overlay, Escape closes it
- No shortcuts fire when typing in search/filter inputs
- Triage number keys disabled during edit mode
- Escape in edit mode exits edit mode (does not close modal)
- Undo resets when changing samples
</verification>

<success_criteria>
- j/k navigate between samples in the modal
- 1-4 set/toggle triage tags (TP, FP, FN, Mistake)
- h toggles highlight mode from modal
- e toggles edit mode from modal
- Delete/Backspace deletes selected annotation in edit mode
- Ctrl+Z/Cmd+Z restores last deleted annotation (single level)
- Escape exits edit mode without closing modal
- ? opens help overlay with all 16 shortcuts grouped by category
- No regressions in existing modal/grid behavior
</success_criteria>

<output>
After completion, create `.planning/phases/13-keyboard-shortcuts/13-02-SUMMARY.md`
</output>
