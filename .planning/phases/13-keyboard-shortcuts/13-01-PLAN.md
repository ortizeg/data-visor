---
phase: 13-keyboard-shortcuts
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/package.json
  - frontend/src/lib/shortcuts.ts
  - frontend/src/stores/ui-store.ts
  - frontend/src/hooks/use-grid-navigation.ts
  - frontend/src/components/grid/image-grid.tsx
  - frontend/src/components/grid/grid-cell.tsx
autonomous: true

must_haves:
  truths:
    - "Arrow keys and j/k move a visible focus ring through grid cells"
    - "ArrowDown/ArrowUp move focus by one row (columnsPerRow cells)"
    - "Enter on a focused grid cell opens the detail modal for that sample"
    - "Focus ring scrolls into view when navigating off-screen"
    - "Shortcuts do not fire while typing in text inputs"
    - "Focus index resets when samples array changes length (filter applied)"
  artifacts:
    - path: "frontend/src/lib/shortcuts.ts"
      provides: "Central shortcut registry consumed by hooks and help overlay"
      exports: ["SHORTCUTS", "ShortcutDef"]
    - path: "frontend/src/hooks/use-grid-navigation.ts"
      provides: "Grid navigation hook with arrow/j/k/Enter bindings"
      exports: ["useGridNavigation"]
    - path: "frontend/src/stores/ui-store.ts"
      provides: "focusedGridIndex and isHelpOverlayOpen state"
      contains: "focusedGridIndex"
  key_links:
    - from: "frontend/src/hooks/use-grid-navigation.ts"
      to: "frontend/src/stores/ui-store.ts"
      via: "reads focusedGridIndex, calls setFocusedGridIndex and openDetailModal"
      pattern: "useUIStore.*focusedGridIndex"
    - from: "frontend/src/components/grid/image-grid.tsx"
      to: "frontend/src/hooks/use-grid-navigation.ts"
      via: "calls useGridNavigation with samples, columnsPerRow, scrollToRow"
      pattern: "useGridNavigation"
    - from: "frontend/src/components/grid/grid-cell.tsx"
      to: "frontend/src/stores/ui-store.ts"
      via: "reads focusedGridIndex to show ring-2 ring-blue-500 focus indicator"
      pattern: "focusedGridIndex"
---

<objective>
Install react-hotkeys-hook, create the shortcut registry, extend the UI store, and implement grid-level keyboard navigation with a visible focus ring.

Purpose: Establishes the keyboard shortcut foundation (library, registry, store state) and delivers grid navigation -- the most visible user-facing shortcut feature (UX-01 grid portion).

Output: Users can navigate the image grid entirely with keyboard. Focus ring moves with arrow keys / j/k, Enter opens the detail modal.
</objective>

<execution_context>
@/Users/ortizeg/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ortizeg/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-keyboard-shortcuts/13-RESEARCH.md
@frontend/src/stores/ui-store.ts
@frontend/src/components/grid/image-grid.tsx
@frontend/src/components/grid/grid-cell.tsx
@frontend/src/types/triage.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install react-hotkeys-hook, create shortcut registry, extend UI store</name>
  <files>
    frontend/package.json
    frontend/src/lib/shortcuts.ts
    frontend/src/stores/ui-store.ts
  </files>
  <action>
1. Install react-hotkeys-hook:
   ```bash
   cd frontend && npm install react-hotkeys-hook
   ```

2. Create `frontend/src/lib/shortcuts.ts` with the central shortcut registry. This file defines ALL keyboard shortcuts as data -- consumed by both useHotkeys calls and the help overlay. Follow the exact structure from RESEARCH.md Pattern 2:

   ```typescript
   export interface ShortcutDef {
     keys: string;          // react-hotkeys-hook key string
     display: string;       // Human-readable key label for help overlay
     label: string;         // Action description
     group: 'navigation' | 'triage' | 'editing' | 'general';
     context?: string;      // When active ("Grid view", "Modal open", etc.)
   }
   ```

   Include all shortcuts from the research: navigation (j/ArrowRight, k/ArrowLeft, ArrowDown, ArrowUp, Enter, Escape), triage (1, 2, 3, 4, h), editing (e, Delete/Backspace, ctrl+z/meta+z), general (shift+/).

3. Extend `frontend/src/stores/ui-store.ts`:
   - Add `focusedGridIndex: number | null` state (default: null)
   - Add `setFocusedGridIndex: (index: number | null) => void` action
   - Add `isHelpOverlayOpen: boolean` state (default: false)
   - Add `toggleHelpOverlay: () => void` action
   - Do NOT modify existing fields or actions. Only add new ones.
  </action>
  <verify>
    - `cd frontend && npx tsc --noEmit` passes with no errors
    - `frontend/src/lib/shortcuts.ts` exports SHORTCUTS array with 16 entries
    - `frontend/src/stores/ui-store.ts` has focusedGridIndex and isHelpOverlayOpen in the interface
  </verify>
  <done>
    react-hotkeys-hook installed, shortcut registry created with all 16 shortcuts, ui-store extended with focusedGridIndex (null), setFocusedGridIndex, isHelpOverlayOpen (false), toggleHelpOverlay
  </done>
</task>

<task type="auto">
  <name>Task 2: Grid navigation hook, image-grid wiring, and focus ring styling</name>
  <files>
    frontend/src/hooks/use-grid-navigation.ts
    frontend/src/components/grid/image-grid.tsx
    frontend/src/components/grid/grid-cell.tsx
  </files>
  <action>
1. Create `frontend/src/hooks/use-grid-navigation.ts` following RESEARCH.md Pattern 4:

   ```typescript
   export function useGridNavigation(
     samples: Sample[],
     columnsPerRow: number,
     scrollToRow: (rowIndex: number) => void,
   )
   ```

   Implementation:
   - Read `isDetailModalOpen`, `activeTab`, `focusedGridIndex`, `setFocusedGridIndex`, `openDetailModal` from useUIStore
   - `enabled = activeTab === 'grid' && !isDetailModalOpen` (disable all grid shortcuts when modal is open or on non-grid tab)
   - Create a `moveTo(newIdx)` helper that clamps to [0, samples.length - 1], calls setFocusedGridIndex, and calls scrollToRow(Math.floor(clamped / columnsPerRow))
   - Register 5 useHotkeys calls:
     - `'j, ArrowRight'` -> moveTo(current + 1)
     - `'k, ArrowLeft'` -> moveTo(current - 1)
     - `'ArrowDown'` -> moveTo(current + columnsPerRow)
     - `'ArrowUp'` -> moveTo(current - columnsPerRow)
     - `'Enter'` -> openDetailModal(samples[focusedGridIndex].id) if focusedGridIndex is not null
   - All useHotkeys calls: `{ enabled, preventDefault: true }` and pass deps array `[focusedGridIndex, samples.length, columnsPerRow]`
   - For j/k starting from null, use (focusedGridIndex ?? -1) + 1 for forward, (focusedGridIndex ?? 0) - 1 for backward (clamped to 0)
   - Add a useEffect that resets focusedGridIndex to null when `samples.length` changes (handles filter changes per Pitfall 5 from research)

2. Wire into `frontend/src/components/grid/image-grid.tsx`:
   - Import and call `useGridNavigation(allSamples, columnsPerRow, scrollToRow)`
   - Create the scrollToRow callback: `(rowIndex: number) => rowVirtualizer.scrollToIndex(rowIndex)`
   - Place the hook call AFTER the rowVirtualizer is created

3. Add focus ring to `frontend/src/components/grid/grid-cell.tsx`:
   - Accept new prop `isFocused: boolean`
   - When `isFocused` is true, add `ring-2 ring-blue-500` class to the outer button element (same style as selection ring but always visible, not just on hover)
   - In image-grid.tsx, pass `isFocused={focusedGridIndex === sampleIdx}` to each GridCell. Read `focusedGridIndex` from useUIStore in image-grid.tsx.

IMPORTANT: Do NOT use enableOnFormTags for these shortcuts. The default behavior (suppressed in inputs) is correct per Pitfall 1 from research.
  </action>
  <verify>
    - `cd frontend && npx tsc --noEmit` passes
    - `cd frontend && npm run build` completes without errors
    - Manual test: load a dataset, press j/ArrowRight -- blue focus ring appears and moves through grid cells. Press Enter -- detail modal opens for focused cell.
  </verify>
  <done>
    Grid cells are navigable via j/k/arrows with a visible blue focus ring. Enter opens the detail modal for the focused cell. Focus scrolls into view via virtualizer. Focus resets on filter change.
  </done>
</task>

</tasks>

<verification>
- `cd frontend && npx tsc --noEmit` passes
- `cd frontend && npm run build` completes
- 16 shortcut definitions exist in shortcuts.ts
- focusedGridIndex state works in ui-store
- Grid navigation responds to j, k, ArrowRight, ArrowLeft, ArrowUp, ArrowDown, Enter
- Focus ring visible on the currently focused grid cell
- Shortcuts suppressed when typing in filter/search inputs
</verification>

<success_criteria>
- react-hotkeys-hook v5 installed and importable
- Shortcut registry has all 16 shortcuts with keys, display, label, group, context
- UI store has focusedGridIndex (null default) and isHelpOverlayOpen (false default)
- Grid navigation works with visible focus ring and scroll-to-view
- Focus index clamps to valid range and resets on sample count change
- No TypeScript errors, build passes
</success_criteria>

<output>
After completion, create `.planning/phases/13-keyboard-shortcuts/13-01-SUMMARY.md`
</output>
