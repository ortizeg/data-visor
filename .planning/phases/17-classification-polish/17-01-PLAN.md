---
phase: 17-classification-polish
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/src/components/stats/confusion-matrix.tsx
  - frontend/src/components/stats/evaluation-panel.tsx
autonomous: true

must_haves:
  truths:
    - "Confusion matrix is readable at 43+ classes with threshold filtering hiding low-value cells"
    - "Confusion matrix scrolls within constrained container at high cardinality"
    - "User sees a ranked list of most-confused class pairs below the confusion matrix"
    - "User sees color-coded F1 bars (green/yellow/red) in the per-class metrics table"
  artifacts:
    - path: "frontend/src/components/stats/confusion-matrix.tsx"
      provides: "Threshold slider, compact cells, overflow scroll container"
      contains: "threshold"
    - path: "frontend/src/components/stats/evaluation-panel.tsx"
      provides: "MostConfusedPairs component, F1Bar component in ClassificationPerClassTable"
      contains: "MostConfusedPairs"
  key_links:
    - from: "frontend/src/components/stats/evaluation-panel.tsx"
      to: "frontend/src/components/stats/confusion-matrix.tsx"
      via: "ConfusionMatrix component usage"
      pattern: "<ConfusionMatrix"
---

<objective>
Add confusion matrix threshold filtering with overflow scroll for 43+ class readability, a most-confused class pairs summary derived client-side from the confusion matrix, and color-coded F1 bars in the classification per-class metrics table.

Purpose: Make classification evaluation production-ready for high-cardinality datasets where raw numbers are hard to scan and full confusion matrices are unreadable.
Output: Enhanced confusion-matrix.tsx with threshold slider and compact mode, evaluation-panel.tsx with MostConfusedPairs and F1Bar inline components.
</objective>

<execution_context>
@/Users/ortizeg/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ortizeg/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-classification-polish/17-RESEARCH.md
@frontend/src/components/stats/confusion-matrix.tsx
@frontend/src/components/stats/evaluation-panel.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Confusion matrix threshold filtering and overflow scroll</name>
  <files>frontend/src/components/stats/confusion-matrix.tsx</files>
  <action>
Enhance the ConfusionMatrix component for high-cardinality (43+ classes) readability:

1. **Threshold slider state:** Add `const [threshold, setThreshold] = useState(0.01)` inside the component. Render a slider in the header area next to the title:
   - Range: 0 to 0.5, step 0.01
   - Show current value as percentage: `{(threshold*100).toFixed(0)}%`
   - Label: "Min:"
   - Also show a count of hidden cells: `{hiddenCount} cells hidden`

2. **Cell rendering with threshold:** In the cell render loop, only show the numeric value if `norm >= threshold || ri === ci` (always show diagonal cells regardless of threshold). When a cell is below threshold AND not diagonal, render the `<td>` with transparent background and no text content.

3. **Overflow scroll container:** Wrap the table in a container with `overflow-auto max-h-[500px]` so large matrices scroll vertically and horizontally.

4. **Compact mode for high cardinality:** When `labels.length > 20`:
   - Use `min-w-[24px]` instead of `min-w-[32px]` on cells
   - Add `max-w-[80px] truncate` to row and column label text
   - Use `text-[10px]` for cell values instead of default text-xs

5. **"N cells hidden" counter:** Compute `hiddenCount` by counting off-diagonal cells where `norm > 0 && norm < threshold`. Display next to the slider.

Keep the existing cellColor function, onCellClick behavior, row-normalization, axis titles, and rotated column headers exactly as they are.
  </action>
  <verify>
Run `cd frontend && npx tsc --noEmit` to confirm no type errors. Visually inspect that the component renders with the slider and that the threshold slider appears in the header area.
  </verify>
  <done>
Confusion matrix has a threshold slider (0-50%, default 1%) that hides low-value off-diagonal cells. Diagonal cells always visible. Table scrolls within a max-h-[500px] container. High-cardinality (>20 classes) uses compact cell sizing and truncated labels. Hidden cell count displayed.
  </done>
</task>

<task type="auto">
  <name>Task 2: Most-confused pairs summary and F1 bars in per-class table</name>
  <files>frontend/src/components/stats/evaluation-panel.tsx</files>
  <action>
Add two inline components to evaluation-panel.tsx for the classification evaluation layout:

**1. MostConfusedPairs component** (inline, above the per-class table in the classification layout):

```tsx
function MostConfusedPairs({
  matrix,
  labels,
  onPairClick,
}: {
  matrix: number[][];
  labels: string[];
  onPairClick?: (actual: string, predicted: string) => void;
}) {
```

- Derive the top 10 most-confused (actual, predicted) pairs from the confusion matrix.
- For each pair: extract raw count `matrix[i][j]` where `i !== j`, compute percentage as `matrix[i][j] / rowSum`.
- Sort by raw count descending, take top 10.
- Render as a compact card with title "Most Confused Pairs" and a table:
  - Columns: Rank (#), Actual, arrow (unicode right arrow), Predicted, Count, Pct
  - Each row is clickable if `onPairClick` is provided (reuse the same handleCellClick logic for confusion cell filtering).
  - Style: rounded-lg border, same card styling as other evaluation cards.
- Skip pairs with count === 0. If no off-diagonal errors exist, show "No misclassifications found".

**2. F1Bar component** (inline, used in ClassificationPerClassTable):

```tsx
function F1Bar({ f1 }: { f1: number }) {
  const color = f1 >= 0.8 ? "bg-green-500" : f1 >= 0.5 ? "bg-yellow-500" : "bg-red-500";
  return (
    <div className="w-16 h-2.5 bg-zinc-200 dark:bg-zinc-700 rounded-full overflow-hidden">
      <div className={`h-full rounded-full ${color}`} style={{ width: `${f1 * 100}%` }} />
    </div>
  );
}
```

- Pure CSS bar, no Recharts dependency. Width proportional to F1 (0-1 scale). Green >= 0.8, yellow >= 0.5, red < 0.5.

**3. Integrate into ClassificationPerClassTable:**
- Add a "Performance" column header after Support.
- In each row, render `<F1Bar f1={m.f1} />` in the new column.

**4. Integrate MostConfusedPairs into classification layout:**
- Place `<MostConfusedPairs>` between the ConfusionMatrix and the ClassificationPerClassTable in the classification evaluation JSX.
- Pass `matrix={classData.confusion_matrix}`, `labels={classData.confusion_matrix_labels}`, `onPairClick={handleCellClick}`.
- Wrap in the same loading skeleton pattern as the other sections.
  </action>
  <verify>
Run `cd frontend && npx tsc --noEmit` to confirm no type errors. Check that the classification evaluation panel now has: metric cards, confusion matrix, most-confused pairs, and per-class table with F1 bars.
  </verify>
  <done>
Classification evaluation panel shows a "Most Confused Pairs" ranked list (top 10) derived from the confusion matrix with clickable rows that filter the grid. Per-class table has a new "Performance" column with color-coded F1 bars (green/yellow/red).
  </done>
</task>

</tasks>

<verification>
1. `cd frontend && npx tsc --noEmit` passes with no errors
2. Confusion matrix has threshold slider visible in header
3. MostConfusedPairs component renders between confusion matrix and per-class table
4. F1 bars appear in the per-class metrics table Performance column
5. Detection evaluation layout is completely unchanged
</verification>

<success_criteria>
- Confusion matrix readable at 43+ classes via threshold filtering and scroll overflow
- Most-confused pairs summary visible and clickable (filters grid)
- F1 bars with green/yellow/red thresholds visible in per-class table
- No regressions to detection evaluation
</success_criteria>

<output>
After completion, create `.planning/phases/17-classification-polish/17-01-SUMMARY.md`
</output>
