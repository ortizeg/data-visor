---
phase: 14-per-annotation-triage
plan: 02
type: execute
wave: 2
depends_on: ["14-01"]
files_modified:
  - frontend/src/types/annotation-triage.ts
  - frontend/src/hooks/use-annotation-triage.ts
  - frontend/src/components/detail/triage-overlay.tsx
autonomous: true

must_haves:
  truths:
    - "useAnnotationTriage hook fetches per-annotation TP/FP/FN classifications from the backend"
    - "useSetAnnotationTriage mutation persists a triage override and invalidates the triage cache"
    - "TriageOverlay component renders color-coded SVG bounding boxes (green=TP, red=FP, orange=FN, purple=mistake)"
    - "Clicking a bounding box in TriageOverlay cycles to the next triage label"
  artifacts:
    - path: "frontend/src/types/annotation-triage.ts"
      provides: "TypeScript types for annotation triage data"
      exports: ["AnnotationTriageResult", "AnnotationTriageResponse", "TRIAGE_CYCLE", "ANNOTATION_TRIAGE_COLORS"]
    - path: "frontend/src/hooks/use-annotation-triage.ts"
      provides: "TanStack Query hooks for fetching and mutating annotation triage"
      exports: ["useAnnotationTriage", "useSetAnnotationTriage", "useRemoveAnnotationTriage"]
    - path: "frontend/src/components/detail/triage-overlay.tsx"
      provides: "Clickable SVG overlay with triage-colored bounding boxes"
      exports: ["TriageOverlay"]
  key_links:
    - from: "frontend/src/hooks/use-annotation-triage.ts"
      to: "/samples/{id}/annotation-triage"
      via: "apiFetch GET call"
      pattern: "annotation-triage"
    - from: "frontend/src/hooks/use-annotation-triage.ts"
      to: "/samples/set-annotation-triage"
      via: "apiPatch mutation"
      pattern: "set-annotation-triage"
    - from: "frontend/src/components/detail/triage-overlay.tsx"
      to: "frontend/src/types/annotation-triage.ts"
      via: "ANNOTATION_TRIAGE_COLORS import for color mapping"
      pattern: "ANNOTATION_TRIAGE_COLORS"
---

<objective>
Build the frontend data layer and triage overlay component for per-annotation triage.

Purpose: Provides the TypeScript types, query/mutation hooks, and interactive SVG overlay that renders color-coded bounding boxes with click-to-override functionality.
Output: Three new frontend files (types, hooks, component) ready to be wired into the sample modal.
</objective>

<execution_context>
@/Users/ortizeg/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ortizeg/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-per-annotation-triage/14-RESEARCH.md
@.planning/phases/14-per-annotation-triage/14-01-SUMMARY.md

# Key source files for implementation patterns
@frontend/src/types/annotation.ts
@frontend/src/types/triage.ts
@frontend/src/hooks/use-triage.ts
@frontend/src/hooks/use-annotations.ts
@frontend/src/components/grid/annotation-overlay.tsx
@frontend/src/lib/api.ts
@frontend/src/stores/ui-store.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: TypeScript types and TanStack Query hooks</name>
  <files>
    frontend/src/types/annotation-triage.ts
    frontend/src/hooks/use-annotation-triage.ts
  </files>
  <action>
    1. **Types** in `frontend/src/types/annotation-triage.ts`:

       ```typescript
       export interface AnnotationTriageResult {
         annotation_id: string;
         auto_label: string;    // "tp" | "fp" | "fn" | "label_error"
         label: string;         // final label after override merge
         matched_id: string | null;
         iou: number | null;
         is_override: boolean;
       }

       export interface AnnotationTriageResponse {
         items: AnnotationTriageResult[];
       }
       ```

       Color mapping constant (matches research spec):
       ```typescript
       export const ANNOTATION_TRIAGE_COLORS: Record<string, string> = {
         tp: "#22c55e",          // green-500
         fp: "#ef4444",          // red-500
         fn: "#f97316",          // orange-500
         label_error: "#eab308", // yellow-500
         mistake: "#a855f7",     // purple-500
       };
       ```

       Cycle order for click-to-advance:
       ```typescript
       export const TRIAGE_CYCLE = ["tp", "fp", "fn", "mistake"] as const;
       ```

       Helper to get next label in cycle:
       ```typescript
       export function nextTriageLabel(current: string): string {
         const idx = TRIAGE_CYCLE.indexOf(current as typeof TRIAGE_CYCLE[number]);
         return TRIAGE_CYCLE[(idx + 1) % TRIAGE_CYCLE.length];
       }
       ```

    2. **Hooks** in `frontend/src/hooks/use-annotation-triage.ts`:
       Follow the pattern from `use-triage.ts` (uses apiFetch, apiPatch, apiDelete from lib/api).

       **useAnnotationTriage(datasetId, sampleId, source, enabled)**:
       - Query key: ["annotation-triage", sampleId, datasetId, source]
       - Fetch: `apiFetch<AnnotationTriageResponse>(`/samples/${sampleId}/annotation-triage?dataset_id=${datasetId}&source=${encodeURIComponent(source)}`)`
       - staleTime: 30_000 (30s)
       - enabled: !!sampleId && enabled
       - select: transform items array into a Record<string, AnnotationTriageResult> mapping annotation_id -> result (for O(1) lookup by the overlay component)

       **useSetAnnotationTriage()**:
       - Mutation body: { annotation_id, dataset_id, sample_id, label }
       - Call: `apiPatch("/samples/set-annotation-triage", body)`
       - onSuccess: invalidate ["annotation-triage"] queries, also invalidate ["samples"] (because sample-level tag changes for highlight mode)

       **useRemoveAnnotationTriage()**:
       - Mutation: `apiDelete(`/samples/${sampleId}/annotation-triage/${annotationId}?dataset_id=${datasetId}`)`
       - onSuccess: invalidate ["annotation-triage"] and ["samples"]
  </action>
  <verify>
    Run `cd /Users/ortizeg/1Projects/⛹️‍♂️\ Next\ Play/code/data-visor/frontend && npx tsc --noEmit` -- no TypeScript errors in the new files.
    Verify imports resolve: check that `annotation-triage.ts` types are self-contained, and hooks import from correct paths.
  </verify>
  <done>
    TypeScript types match the backend AnnotationTriageResponse schema. useAnnotationTriage returns a Record<annotation_id, AnnotationTriageResult> for efficient lookup. Mutations invalidate both annotation-triage and samples caches.
  </done>
</task>

<task type="auto">
  <name>Task 2: TriageOverlay clickable SVG component</name>
  <files>
    frontend/src/components/detail/triage-overlay.tsx
  </files>
  <action>
    Create `frontend/src/components/detail/triage-overlay.tsx` -- a new SVG overlay component for the detail modal that renders triage-colored bounding boxes with click handlers.

    **Key design decisions (from research):**
    - This is a NEW component, NOT a modification of `AnnotationOverlay`. The existing overlay has `pointer-events-none` and is used for the grid (non-interactive). This component has `pointer-events: auto` on individual rects for click interaction.
    - Predictions use dashed stroke (matching AnnotationOverlay convention). GT uses solid stroke.
    - Each box shows category name + triage label (e.g., "person TP", "car FP").
    - Override badges: if is_override is true, show a small "(manual)" indicator or different text styling to distinguish auto from override labels.

    **Props interface:**
    ```typescript
    interface TriageOverlayProps {
      annotations: Annotation[];                              // from useAnnotations
      triageMap: Record<string, AnnotationTriageResult>;       // from useAnnotationTriage
      imageWidth: number;
      imageHeight: number;
      onClickAnnotation: (annotationId: string, currentLabel: string) => void;
    }
    ```

    **Implementation:**
    - SVG with viewBox={`0 0 ${imageWidth} ${imageHeight}`}, preserveAspectRatio="xMidYMid meet", className="absolute inset-0 h-full w-full" (NO pointer-events-none on the SVG itself)
    - For each annotation, look up triage info from triageMap[ann.id]
    - If triage info exists: use ANNOTATION_TRIAGE_COLORS[triage.label] for stroke color
    - If no triage info (annotation not in triage results, e.g., GT-only view): use zinc-400 (#a1a1aa) as default
    - Each `<g>` gets onClick={() => onClickAnnotation(ann.id, triage.label)}, className="cursor-pointer", style={{ pointerEvents: "auto" }}
    - `<rect>` with transparent fill, colored stroke, dashed for predictions
    - `<text>` above the box showing "{category_name} {LABEL}" with the triage color, black stroke outline for readability (same paintOrder technique as AnnotationOverlay)
    - If is_override, append a small "*" after the label to indicate manual override

    **Important:** Only render annotations that have entries in the triageMap. If an annotation is not in the map (e.g., both sources not present), skip it or render with default styling. This handles the case where a sample has GT only (no predictions = no IoU matching = no triage data).
  </action>
  <verify>
    Run `cd /Users/ortizeg/1Projects/⛹️‍♂️\ Next\ Play/code/data-visor/frontend && npx tsc --noEmit` -- no TypeScript errors.
    Verify the component exports correctly: `grep "export function TriageOverlay" frontend/src/components/detail/triage-overlay.tsx` returns a match.
  </verify>
  <done>
    TriageOverlay renders color-coded SVG boxes using triage classification data. Boxes are clickable (pointer-events: auto). Predictions use dashed strokes, GT uses solid. Override annotations show a visual indicator. Component accepts the same imageWidth/imageHeight pattern as AnnotationOverlay for coordinate mapping.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. Types match backend response schema (AnnotationTriageResult fields align with API response)
3. Hooks follow established TanStack Query patterns (query keys, invalidation, enabled guards)
4. TriageOverlay renders SVG with correct viewBox and pointer-events configuration
5. Color mapping covers all triage labels (tp, fp, fn, label_error, mistake)
</verification>

<success_criteria>
- Types, hooks, and component are self-contained new files (no modifications to existing code yet)
- useAnnotationTriage transforms response into Record for O(1) annotation lookup
- TriageOverlay is a separate component from AnnotationOverlay (preserves existing grid overlay behavior)
- Click handler delegates to parent via onClickAnnotation callback (not managing mutation directly)
- Color scheme follows research spec (green=TP, red=FP, orange=FN, yellow=label_error, purple=mistake)
</success_criteria>

<output>
After completion, create `.planning/phases/14-per-annotation-triage/14-02-SUMMARY.md`
</output>
