---
phase: 14-per-annotation-triage
plan: 03
type: execute
wave: 3
depends_on: ["14-02"]
files_modified:
  - frontend/src/components/detail/sample-modal.tsx
  - frontend/src/components/grid/grid-cell.tsx
autonomous: false

must_haves:
  truths:
    - "User opens a sample with GT and predictions and sees each bounding box color-coded as TP/FP/FN based on automatic IoU matching"
    - "User can click an individual bounding box to override its auto-assigned classification"
    - "Per-annotation triage decisions persist across page refreshes"
    - "Highlight mode dims samples that have no triage annotations, making triaged samples visually prominent"
  artifacts:
    - path: "frontend/src/components/detail/sample-modal.tsx"
      provides: "TriageOverlay integration replacing AnnotationOverlay when triage data is available"
      contains: "TriageOverlay"
    - path: "frontend/src/components/grid/grid-cell.tsx"
      provides: "Highlight mode support for triage:annotated tag"
      contains: "triage:annotated"
  key_links:
    - from: "frontend/src/components/detail/sample-modal.tsx"
      to: "frontend/src/hooks/use-annotation-triage.ts"
      via: "useAnnotationTriage + useSetAnnotationTriage hooks"
      pattern: "useAnnotationTriage|useSetAnnotationTriage"
    - from: "frontend/src/components/detail/sample-modal.tsx"
      to: "frontend/src/components/detail/triage-overlay.tsx"
      via: "TriageOverlay component render"
      pattern: "<TriageOverlay"
    - from: "frontend/src/components/grid/grid-cell.tsx"
      to: "sample.tags"
      via: "triage:annotated tag check for highlight mode"
      pattern: "triage:annotated|triage:"
---

<objective>
Wire the triage overlay into the sample detail modal and integrate per-annotation triage with highlight mode.

Purpose: This is the final integration plan -- connects all the backend and frontend building blocks into the user-facing experience. After this plan, users can see color-coded boxes, click to override, and use highlight mode with annotation-triaged samples.
Output: Modified sample-modal.tsx with triage overlay integration and grid-cell.tsx with highlight mode awareness.
</objective>

<execution_context>
@/Users/ortizeg/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ortizeg/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-per-annotation-triage/14-RESEARCH.md
@.planning/phases/14-per-annotation-triage/14-01-SUMMARY.md
@.planning/phases/14-per-annotation-triage/14-02-SUMMARY.md

# Key source files to modify
@frontend/src/components/detail/sample-modal.tsx
@frontend/src/components/grid/grid-cell.tsx

# Dependencies from Plan 02
@frontend/src/types/annotation-triage.ts
@frontend/src/hooks/use-annotation-triage.ts
@frontend/src/components/detail/triage-overlay.tsx
@frontend/src/stores/ui-store.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire TriageOverlay into sample modal</name>
  <files>
    frontend/src/components/detail/sample-modal.tsx
  </files>
  <action>
    Modify `frontend/src/components/detail/sample-modal.tsx` to show the TriageOverlay when triage data is available.

    **Imports to add:**
    ```typescript
    import { TriageOverlay } from "./triage-overlay";
    import { useAnnotationTriage, useSetAnnotationTriage } from "@/hooks/use-annotation-triage";
    import { nextTriageLabel } from "@/types/annotation-triage";
    ```

    **Hook setup** (add after existing hook calls, around line 102-110):
    ```typescript
    // Determine the active prediction source for IoU matching
    const predSource = predAnnotations.length > 0
      ? predAnnotations[0].source
      : null;

    // Per-annotation triage: only fetch when both GT and predictions exist
    const hasBothSources = gtAnnotations.length > 0 && predAnnotations.length > 0;
    const { data: triageMap } = useAnnotationTriage(
      datasetId,
      selectedSampleId,
      predSource ?? "prediction",
      hasBothSources && !isEditMode,  // disable during edit mode (Konva takes over)
    );

    const setAnnotationTriage = useSetAnnotationTriage();
    ```

    **Click handler** (add as a useCallback):
    ```typescript
    const handleTriageClick = useCallback(
      (annotationId: string, currentLabel: string) => {
        if (!selectedSampleId) return;
        const next = nextTriageLabel(currentLabel);
        setAnnotationTriage.mutate({
          annotation_id: annotationId,
          dataset_id: datasetId,
          sample_id: selectedSampleId,
          label: next,
        });
      },
      [datasetId, selectedSampleId, setAnnotationTriage],
    );
    ```

    **Render logic change** in the image display section (around line 354-369):
    Replace the existing non-edit-mode block. When NOT in edit mode:
    - If triageMap exists and has entries (both GT + predictions present): render TriageOverlay instead of AnnotationOverlay
    - Otherwise: render the existing AnnotationOverlay (preserves behavior for GT-only or prediction-only samples)

    The modified JSX (inside the `!isEditMode` branch):
    ```tsx
    <>
      <img
        src={fullImageUrl(datasetId, sample.id)}
        alt={sample.file_name}
        className="h-auto w-full"
        decoding="async"
      />
      {annotations && annotations.length > 0 && (
        triageMap && Object.keys(triageMap).length > 0 ? (
          <TriageOverlay
            annotations={annotations}
            triageMap={triageMap}
            imageWidth={sample.width}
            imageHeight={sample.height}
            onClickAnnotation={handleTriageClick}
          />
        ) : (
          <AnnotationOverlay
            annotations={annotations}
            imageWidth={sample.width}
            imageHeight={sample.height}
          />
        )
      )}
    </>
    ```

    **Source filtering awareness** (from research Pitfall 4): The useAnnotationTriage hook is only enabled when `hasBothSources` is true. If the user has filtered sources to GT-only via the UI store activeSources, the `predAnnotations` array will be empty, `hasBothSources` will be false, and the regular AnnotationOverlay will render. This handles the source filter interaction correctly.

    **Edit mode interaction**: When isEditMode is true, the Konva AnnotationEditor renders (existing behavior). When switching out of edit mode, the TriageOverlay renders again. The `!isEditMode` guard on the useAnnotationTriage enabled parameter prevents unnecessary fetches during editing.
  </action>
  <verify>
    Run `cd /Users/ortizeg/1Projects/⛹️‍♂️\ Next\ Play/code/data-visor/frontend && npx tsc --noEmit` -- no TypeScript errors.
    Run `npm run build` -- build succeeds.
  </verify>
  <done>
    TriageOverlay replaces AnnotationOverlay when both GT and prediction annotations exist (non-edit mode). Click advances triage label via the cycle. Falls back to standard AnnotationOverlay for GT-only samples or when triage data is unavailable. Edit mode still renders AnnotationEditor (unchanged).
  </done>
</task>

<task type="auto">
  <name>Task 2: Highlight mode awareness for annotation-triaged samples</name>
  <files>
    frontend/src/components/grid/grid-cell.tsx
  </files>
  <action>
    The highlight mode dimming logic in `grid-cell.tsx` already checks for `triage:` prefix tags:
    ```typescript
    const hasTriageTag = tags.some((t) => t.startsWith("triage:"));
    ```

    The backend (Plan 01) already sets a `triage:annotated` tag on the sample when a per-annotation triage override is created. Since `"triage:annotated".startsWith("triage:")` is true, the existing highlight mode logic will automatically keep annotation-triaged samples visible (not dimmed).

    **Verification-only change**: No code change needed in grid-cell.tsx for highlight mode to work. The `triage:annotated` tag from the backend is sufficient.

    **However**, update the `triageTagStyle` function to handle the new `triage:annotated` tag with appropriate styling:
    ```typescript
    case "triage:annotated":
      return "bg-purple-100 text-purple-800 dark:bg-purple-900 dark:text-purple-200";
    ```

    **Also** update the tag label display: the existing line `tag.startsWith("triage:") ? tag.slice(7).toUpperCase() : tag` will show "ANNOTATED" for `triage:annotated`, which is a reasonable label. No change needed there.
  </action>
  <verify>
    Run `cd /Users/ortizeg/1Projects/⛹️‍♂️\ Next\ Play/code/data-visor/frontend && npx tsc --noEmit` -- no TypeScript errors.
    Grep for the new case: `grep "triage:annotated" frontend/src/components/grid/grid-cell.tsx` returns the new style case.
  </verify>
  <done>
    Highlight mode correctly dims samples without any triage tag (sample-level or annotation-level). Samples with `triage:annotated` tag (set by annotation triage backend) remain visible. Tag badge shows "ANNOTATED" with purple styling.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete per-annotation triage system: auto-computed TP/FP/FN color-coded bounding boxes in the detail modal with click-to-override, persisted to DuckDB, and integrated with highlight mode.</what-built>
  <how-to-verify>
    1. Start the full stack: backend (`uvicorn app.main:app`) + frontend (`npm run dev`)
    2. Open a dataset that has both ground truth AND prediction annotations
    3. Click a sample to open the detail modal
    4. VERIFY: Bounding boxes should be color-coded -- green (TP), red (FP), orange (FN), yellow (label error) instead of the usual source-based colors
    5. VERIFY: Each box label shows the category name + triage label (e.g., "person TP", "car FP")
    6. Click a bounding box -- the label should cycle to the next classification (TP -> FP -> FN -> mistake -> TP)
    7. Close the modal and reopen -- the override should persist
    8. Toggle highlight mode (h key or button) -- samples with annotation triage overrides should remain bright, others should dim
    9. Open a sample that has ONLY ground truth (no predictions) -- should show the normal AnnotationOverlay (no triage colors)
    10. Enter edit mode -- should switch to Konva editor as before (triage overlay disappears)
  </how-to-verify>
  <resume-signal>Type "approved" or describe any issues</resume-signal>
</task>

</tasks>

<verification>
1. TypeScript compiles without errors (`npx tsc --noEmit`)
2. Frontend builds successfully (`npm run build`)
3. Detail modal shows triage-colored boxes when GT + predictions both exist
4. Clicking a box cycles the triage label and persists the override
5. Highlight mode works with annotation-triaged samples (triage:annotated tag)
6. Edit mode still works correctly (Konva editor renders, triage overlay disabled)
7. GT-only samples fall back to standard AnnotationOverlay
</verification>

<success_criteria>
- Color-coded bounding boxes visible in detail modal for samples with GT + predictions
- Click-to-override cycles through TP/FP/FN/mistake labels
- Overrides persist across modal close/reopen and page refresh
- Highlight mode correctly includes annotation-triaged samples
- No regression in edit mode, draw mode, or existing triage functionality
- Source filter interaction works (GT-only view shows standard overlay)
</success_criteria>

<output>
After completion, create `.planning/phases/14-per-annotation-triage/14-03-SUMMARY.md`
</output>
