---
phase: 04-predictions-comparison
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - app/routers/samples.py
  - frontend/src/stores/ui-store.ts
  - frontend/src/components/grid/annotation-overlay.tsx
  - frontend/src/components/toolbar/overlay-toggle.tsx
  - frontend/src/hooks/use-annotations.ts
  - frontend/src/app/datasets/[datasetId]/page.tsx
  - frontend/src/types/dataset.ts
autonomous: true

must_haves:
  truths:
    - "User can toggle between GT-only, Predictions-only, and Both in a segmented control"
    - "GT annotations render with solid lines, predictions render with dashed lines"
    - "Prediction annotations display confidence percentage next to the class label"
    - "Switching overlay mode only fetches the annotations needed (server-side source filter)"
  artifacts:
    - path: "frontend/src/components/toolbar/overlay-toggle.tsx"
      provides: "Segmented control for GT/Pred/Both toggle"
      contains: "OverlayMode"
    - path: "frontend/src/stores/ui-store.ts"
      provides: "overlayMode state in Zustand store"
      contains: "overlayMode"
    - path: "frontend/src/components/grid/annotation-overlay.tsx"
      provides: "Source-aware SVG rendering with dashed vs solid lines"
      contains: "strokeDasharray"
    - path: "app/routers/samples.py"
      provides: "Optional source query param on batch-annotations endpoint"
      contains: "source.*Query"
  key_links:
    - from: "frontend/src/components/toolbar/overlay-toggle.tsx"
      to: "frontend/src/stores/ui-store.ts"
      via: "setOverlayMode action"
      pattern: "useUIStore.*setOverlayMode"
    - from: "frontend/src/hooks/use-annotations.ts"
      to: "app/routers/samples.py"
      via: "source query param in batch-annotations URL"
      pattern: "source=.*overlayMode"
    - from: "frontend/src/components/grid/annotation-overlay.tsx"
      to: "annotation.source"
      via: "strokeDasharray conditional on source === 'prediction'"
      pattern: "source.*prediction.*dasharray"
---

<objective>
Add GT vs Predictions comparison toggle so users can visually distinguish ground truth annotations from model predictions using solid vs dashed line rendering, with a three-way segmented control.

Purpose: This is the core comparison feature (GRID-03) -- users need to see how predictions differ from ground truth spatially on each image.

Output: Overlay mode toggle in UI, source-aware SVG rendering, server-side source filtering on batch annotations.
</objective>

<execution_context>
@/Users/ortizeg/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ortizeg/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-predictions-comparison/04-RESEARCH.md
@.planning/phases/04-predictions-comparison/04-01-SUMMARY.md

Source files to modify (read before implementing):
@frontend/src/stores/ui-store.ts -- Add overlayMode state
@frontend/src/components/grid/annotation-overlay.tsx -- Add source-aware rendering
@frontend/src/hooks/use-annotations.ts -- Add source param to batch query
@app/routers/samples.py -- Add source filter to batch-annotations endpoint
@frontend/src/app/datasets/[datasetId]/page.tsx -- Mount overlay toggle in header
@frontend/src/types/dataset.ts -- Add prediction_count to Dataset type
</context>

<tasks>

<task type="auto">
  <name>Task 1: Backend source filter on batch annotations endpoint</name>
  <files>
    app/routers/samples.py
    frontend/src/types/dataset.ts
  </files>
  <action>
    **1. Add `source` query parameter to batch-annotations endpoint in `app/routers/samples.py`:**
    - Add optional parameter: `source: str | None = Query(None, description="Filter by annotation source: ground_truth, prediction, or omit for all")`
    - In the SQL query, append `AND source = ?` when source is provided
    - When source is None, return all annotations (current behavior, no change)
    - Update the params list conditionally:
      ```python
      source_clause = ""
      if source:
          source_clause = " AND source = ?"
          params.append(source)
      ```
    - Apply the same source filter to the per-sample annotations endpoint `GET /samples/{sample_id}/annotations` for consistency

    **2. Update `frontend/src/types/dataset.ts`:**
    - Add `prediction_count: number` field to the `Dataset` interface to match the updated backend DatasetResponse (from Plan 04-01)

    This task is backend-focused and can be verified independently before the frontend changes.
  </action>
  <verify>
    - `python -m pytest tests/ -v` -- all tests pass (no regressions)
    - Manual curl: `curl "http://localhost:8000/samples/batch-annotations?dataset_id=X&sample_ids=1,2&source=ground_truth"` returns only GT annotations
    - Manual curl: `curl "http://localhost:8000/samples/batch-annotations?dataset_id=X&sample_ids=1,2&source=prediction"` returns only predictions
    - Manual curl without source param returns all (backward compatible)
  </verify>
  <done>
    Batch-annotations and per-sample annotations endpoints accept an optional `source` query parameter that filters annotations by source value server-side. Omitting the parameter returns all annotations (backward compatible). Dataset type updated with prediction_count.
  </done>
</task>

<task type="auto">
  <name>Task 2: Overlay mode toggle and source-aware SVG rendering</name>
  <files>
    frontend/src/stores/ui-store.ts
    frontend/src/components/toolbar/overlay-toggle.tsx
    frontend/src/components/grid/annotation-overlay.tsx
    frontend/src/hooks/use-annotations.ts
    frontend/src/app/datasets/[datasetId]/page.tsx
  </files>
  <action>
    **1. Add overlayMode to `frontend/src/stores/ui-store.ts`:**
    - Add type: `type OverlayMode = "ground_truth" | "prediction" | "both";` (export it)
    - Add state fields to UIState interface: `overlayMode: OverlayMode;` and `setOverlayMode: (mode: OverlayMode) => void;`
    - Default: `overlayMode: "ground_truth"` (GT-only by default; predictions may not exist)
    - Add setter: `setOverlayMode: (mode) => set({ overlayMode: mode })`

    **2. Create `frontend/src/components/toolbar/overlay-toggle.tsx`:**
    - A segmented button group (3 buttons: "GT", "Pred", "Both")
    - Read `overlayMode` and `setOverlayMode` from `useUIStore`
    - Render as a flex row of buttons with Tailwind styling:
      - Active button: `bg-zinc-900 text-white dark:bg-zinc-100 dark:text-zinc-900`
      - Inactive button: `bg-zinc-100 text-zinc-600 hover:bg-zinc-200 dark:bg-zinc-800 dark:text-zinc-400`
      - Container: `inline-flex rounded-lg border border-zinc-200 dark:border-zinc-700 overflow-hidden`
    - Each button calls `setOverlayMode(value)` on click
    - Export: `OverlayToggle` component
    - Only show when dataset has predictions: accept `hasPredictions: boolean` prop. If false, don't render (return null).

    **3. Update `frontend/src/hooks/use-annotations.ts`:**
    - In `useAnnotationsBatch`, read `overlayMode` from `useUIStore`
    - Map overlayMode to source query param:
      - `"ground_truth"` -> `&source=ground_truth`
      - `"prediction"` -> `&source=prediction`
      - `"both"` -> omit source param (returns all)
    - Include `overlayMode` in the queryKey so TanStack Query refetches when mode changes:
      `queryKey: ["annotations-batch", datasetId, overlayMode, ...sortedIds]`
    - Change `staleTime` from `Infinity` to `5 * 60 * 1000` (5 min) since annotations can now change after prediction import
    - Apply the same source param logic to `useAnnotations` (single-sample hook for detail modal)

    **4. Update `frontend/src/components/grid/annotation-overlay.tsx`:**
    - Add source-aware rendering to the SVG rect:
      ```tsx
      const isPrediction = ann.source === "prediction";
      const dashLen = strokeWidth * 4;
      const gapLen = strokeWidth * 2;
      ```
    - On `<rect>`: add `strokeDasharray={isPrediction ? `${dashLen},${gapLen}` : "none"}`
    - On `<text>`: append confidence percentage for predictions:
      ```tsx
      {ann.category_name}
      {isPrediction && ann.confidence !== null ? ` ${(ann.confidence * 100).toFixed(0)}%` : ""}
      ```
    - No changes to the component props interface -- `annotations` already contains `source` and `confidence` fields

    **5. Mount OverlayToggle in `frontend/src/app/datasets/[datasetId]/page.tsx`:**
    - Import `OverlayToggle` from `@/components/toolbar/overlay-toggle`
    - Place it in the header bar, after the dataset info (image count span)
    - Pass `hasPredictions={(dataset?.prediction_count ?? 0) > 0}`
  </action>
  <verify>
    - `cd frontend && npx tsc --noEmit` -- no TypeScript errors
    - `cd frontend && npm run build` -- builds successfully
    - Visual check: Navigate to a dataset page, verify the overlay toggle appears when predictions exist
    - Visual check: Toggle between GT/Pred/Both, verify dashed vs solid lines
    - Verify confidence percentages appear next to prediction labels
  </verify>
  <done>
    Three-way overlay mode toggle (GT/Pred/Both) in the dataset header controls which annotations are visible. GT annotations render with solid lines, predictions render with dashed lines and show confidence percentages. The batch-annotations hook passes the source filter to the backend, so only relevant annotations are fetched. Toggle only appears when dataset has predictions.
  </done>
</task>

</tasks>

<verification>
1. `python -m pytest tests/ -v` -- all backend tests pass
2. `cd frontend && npx tsc --noEmit` -- no TypeScript errors
3. `cd frontend && npm run build` -- build succeeds
4. Batch annotations endpoint with `?source=ground_truth` returns only GT
5. Batch annotations endpoint with `?source=prediction` returns only predictions
6. Batch annotations endpoint without source returns all (backward compatible)
7. OverlayToggle renders GT/Pred/Both buttons
8. SVG rects use dashed stroke for predictions, solid for GT
</verification>

<success_criteria>
- GT annotations render as solid-line bounding boxes
- Predictions render as dashed-line bounding boxes with confidence percentages
- Segmented toggle switches between GT-only, Predictions-only, and Both
- Server-side source filtering reduces payload size when viewing single source
- Toggle only visible when predictions have been imported for the dataset
</success_criteria>

<output>
After completion, create `.planning/phases/04-predictions-comparison/04-02-SUMMARY.md`
</output>
