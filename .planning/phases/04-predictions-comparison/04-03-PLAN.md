---
phase: 04-predictions-comparison
plan: 03
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - app/routers/statistics.py
  - app/models/statistics.py
  - app/main.py
  - frontend/src/types/statistics.ts
  - frontend/src/hooks/use-statistics.ts
  - frontend/src/components/stats/stats-dashboard.tsx
  - frontend/src/components/stats/class-distribution.tsx
  - frontend/src/components/stats/split-breakdown.tsx
  - frontend/src/components/stats/annotation-summary.tsx
  - frontend/src/app/datasets/[datasetId]/page.tsx
  - frontend/src/stores/ui-store.ts
autonomous: true

must_haves:
  truths:
    - "User can switch between Grid and Statistics tabs on the dataset page"
    - "User can see a bar chart showing class distribution with GT and prediction counts side by side"
    - "User can see split breakdown (train/val/test) as a chart"
    - "User can see summary statistics: total images, GT annotations, predictions, categories"
  artifacts:
    - path: "app/routers/statistics.py"
      provides: "GET /datasets/{dataset_id}/statistics endpoint"
      contains: "GROUP BY"
    - path: "app/models/statistics.py"
      provides: "DatasetStatistics, ClassDistribution, SplitBreakdown, SummaryStats models"
      exports: ["DatasetStatistics"]
    - path: "frontend/src/components/stats/stats-dashboard.tsx"
      provides: "Statistics dashboard layout with charts"
      contains: "use client"
    - path: "frontend/src/components/stats/class-distribution.tsx"
      provides: "Horizontal bar chart with GT and prediction counts per class"
      contains: "BarChart"
    - path: "frontend/src/hooks/use-statistics.ts"
      provides: "TanStack Query hook for statistics data"
      contains: "useStatistics"
  key_links:
    - from: "frontend/src/hooks/use-statistics.ts"
      to: "app/routers/statistics.py"
      via: "apiFetch to /datasets/{id}/statistics"
      pattern: "datasets.*statistics"
    - from: "frontend/src/app/datasets/[datasetId]/page.tsx"
      to: "frontend/src/stores/ui-store.ts"
      via: "activeTab state controlling Grid vs Statistics view"
      pattern: "activeTab"
    - from: "frontend/src/components/stats/stats-dashboard.tsx"
      to: "frontend/src/hooks/use-statistics.ts"
      via: "useStatistics hook providing data to charts"
      pattern: "useStatistics"
---

<objective>
Build a dataset statistics dashboard showing class distribution, annotation counts, and split breakdown as interactive charts, accessible via a tab alongside the grid view.

Purpose: This satisfies EVAL-03 -- users need a birds-eye view of their dataset composition and how predictions compare against ground truth at the dataset level.

Output: Statistics API endpoint, Recharts-powered dashboard with bar and summary charts, and a tab system on the dataset page.
</objective>

<execution_context>
@/Users/ortizeg/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ortizeg/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-predictions-comparison/04-RESEARCH.md
@.planning/phases/04-predictions-comparison/04-01-SUMMARY.md

Source files to reference (read before implementing):
@app/routers/datasets.py -- Endpoint patterns
@app/dependencies.py -- DI pattern
@app/main.py -- Router registration
@frontend/src/app/datasets/[datasetId]/page.tsx -- Dataset page layout to add tabs
@frontend/src/stores/ui-store.ts -- UI store to add activeTab
@frontend/src/lib/api.ts -- apiFetch helper
@frontend/src/lib/constants.ts -- API_BASE
</context>

<tasks>

<task type="auto">
  <name>Task 1: Statistics backend endpoint</name>
  <files>
    app/models/statistics.py
    app/routers/statistics.py
    app/main.py
  </files>
  <action>
    **1. Create `app/models/statistics.py`:**
    - `ClassDistribution(BaseModel)`: `category_name: str`, `gt_count: int`, `pred_count: int`
    - `SplitBreakdown(BaseModel)`: `split_name: str`, `count: int`
    - `SummaryStats(BaseModel)`: `total_images: int`, `gt_annotations: int`, `pred_annotations: int`, `total_categories: int`
    - `DatasetStatistics(BaseModel)`: `class_distribution: list[ClassDistribution]`, `split_breakdown: list[SplitBreakdown]`, `summary: SummaryStats`

    **2. Create `app/routers/statistics.py`:**
    - `router = APIRouter(prefix="/datasets", tags=["statistics"])`
    - `GET /{dataset_id}/statistics` returning `DatasetStatistics`
    - Inject `db: DuckDBRepo = Depends(get_db)`
    - Three DuckDB queries, all server-side aggregation:

    **Class distribution query:**
    ```sql
    SELECT category_name,
           COUNT(*) FILTER (WHERE source = 'ground_truth') as gt_count,
           COUNT(*) FILTER (WHERE source = 'prediction') as pred_count
    FROM annotations WHERE dataset_id = ?
    GROUP BY category_name ORDER BY gt_count DESC
    ```

    **Split breakdown query:**
    ```sql
    SELECT COALESCE(split, 'unassigned') as split_name, COUNT(*) as count
    FROM samples WHERE dataset_id = ?
    GROUP BY split_name ORDER BY count DESC
    ```

    **Summary counts query:**
    ```sql
    SELECT
      (SELECT COUNT(*) FROM samples WHERE dataset_id = ?) as total_images,
      (SELECT COUNT(*) FROM annotations WHERE dataset_id = ? AND source = 'ground_truth') as gt_annotations,
      (SELECT COUNT(*) FROM annotations WHERE dataset_id = ? AND source = 'prediction') as pred_annotations,
      (SELECT COUNT(DISTINCT category_name) FROM annotations WHERE dataset_id = ?) as total_categories
    ```

    - Verify dataset exists first (404 if not)
    - Use cursor with try/finally (same pattern as other routers)
    - Build response from query results

    **3. Register router in `app/main.py`:**
    - Add `from app.routers import statistics` to the import line
    - Add `app.include_router(statistics.router)`
  </action>
  <verify>
    - `python -m pytest tests/ -v` -- all tests pass
    - `python -c "from app.routers.statistics import router; print(router.routes)"` -- shows the statistics route
    - Manual curl: `curl http://localhost:8000/datasets/{id}/statistics` returns JSON with class_distribution, split_breakdown, summary
  </verify>
  <done>
    GET /datasets/{dataset_id}/statistics returns aggregated dataset statistics: class distribution with GT and prediction counts per class, split breakdown with sample counts, and summary statistics (total images, GT annotations, predictions, categories). All computation is server-side via DuckDB GROUP BY queries.
  </done>
</task>

<task type="auto">
  <name>Task 2: Statistics dashboard frontend with tab system</name>
  <files>
    frontend/src/types/statistics.ts
    frontend/src/hooks/use-statistics.ts
    frontend/src/components/stats/stats-dashboard.tsx
    frontend/src/components/stats/class-distribution.tsx
    frontend/src/components/stats/split-breakdown.tsx
    frontend/src/components/stats/annotation-summary.tsx
    frontend/src/stores/ui-store.ts
    frontend/src/app/datasets/[datasetId]/page.tsx
  </files>
  <action>
    **0. Install Recharts (run before implementing):**
    ```bash
    cd frontend && npm install recharts
    ```
    Note: `react-is` peer dependency is satisfied by React 19 in the project. If npm warns, install `react-is@^19.0.0` as well.

    **1. Create `frontend/src/types/statistics.ts`:**
    - Types matching backend models:
      ```typescript
      export interface ClassDistribution {
        category_name: string;
        gt_count: number;
        pred_count: number;
      }
      export interface SplitBreakdown {
        split_name: string;
        count: number;
      }
      export interface SummaryStats {
        total_images: number;
        gt_annotations: number;
        pred_annotations: number;
        total_categories: number;
      }
      export interface DatasetStatistics {
        class_distribution: ClassDistribution[];
        split_breakdown: SplitBreakdown[];
        summary: SummaryStats;
      }
      ```

    **2. Create `frontend/src/hooks/use-statistics.ts`:**
    - `useStatistics(datasetId: string)` using TanStack Query:
      ```typescript
      queryKey: ["statistics", datasetId]
      queryFn: () => apiFetch<DatasetStatistics>(`/datasets/${datasetId}/statistics`)
      staleTime: 5 * 60 * 1000  // 5 min -- invalidated after prediction import
      ```

    **3. Create `frontend/src/components/stats/annotation-summary.tsx`:**
    - "use client" directive
    - Accept `summary: SummaryStats` prop
    - Render a 4-column grid of stat cards:
      - Total Images (summary.total_images)
      - GT Annotations (summary.gt_annotations)
      - Predictions (summary.pred_annotations)
      - Categories (summary.total_categories)
    - Each card: rounded border, large number, small label below
    - Tailwind: `grid grid-cols-2 lg:grid-cols-4 gap-4`
    - Cards: `rounded-lg border border-zinc-200 dark:border-zinc-700 p-4 bg-white dark:bg-zinc-900`

    **4. Create `frontend/src/components/stats/class-distribution.tsx`:**
    - "use client" directive
    - Accept `data: ClassDistribution[]` prop
    - Import `{ BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer }` from "recharts"
    - Render a horizontal bar chart (layout="vertical"):
      - YAxis: category_name (type="category", width=120, truncate long names)
      - XAxis: count (type="number")
      - Two bars: "Ground Truth" (fill="#3b82f6" blue-500) and "Predictions" (fill="#f59e0b" amber-500)
      - CartesianGrid with strokeDasharray="3 3"
      - Tooltip and Legend
    - Wrap in ResponsiveContainer width="100%" height={Math.max(300, data.length * 35)} to scale with category count
    - If data is empty, show "No annotations yet" message

    **5. Create `frontend/src/components/stats/split-breakdown.tsx`:**
    - "use client" directive
    - Accept `data: SplitBreakdown[]` prop
    - Import `{ BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer }` from "recharts"
    - Render a vertical bar chart:
      - XAxis: split_name
      - YAxis: count
      - Single bar: fill="#8b5cf6" (violet-500)
    - Wrap in ResponsiveContainer width="100%" height={250}
    - If data is empty, show "No splits defined" message

    **6. Create `frontend/src/components/stats/stats-dashboard.tsx`:**
    - "use client" directive
    - Accept `datasetId: string` prop
    - Call `useStatistics(datasetId)` to get data
    - Loading state: skeleton placeholders
    - Layout: vertical stack with sections
      - Section 1: AnnotationSummary (summary stats cards)
      - Section 2: ClassDistribution chart with heading "Class Distribution"
      - Section 3: SplitBreakdown chart with heading "Split Breakdown"
    - Each section wrapped in a container with padding and heading
    - Main container: `p-6 overflow-y-auto h-full space-y-6`

    **7. Add activeTab to `frontend/src/stores/ui-store.ts`:**
    - Add type: `type DatasetTab = "grid" | "statistics";` (export it)
    - Add to UIState: `activeTab: DatasetTab;` and `setActiveTab: (tab: DatasetTab) => void;`
    - Default: `activeTab: "grid"`
    - Add setter: `setActiveTab: (tab) => set({ activeTab: tab })`

    **8. Update `frontend/src/app/datasets/[datasetId]/page.tsx`:**
    - Import `StatsDashboard` from `@/components/stats/stats-dashboard`
    - Import `useUIStore` for `activeTab` and `setActiveTab`
    - Add tab buttons in the header (after dataset info, before any overlay toggle):
      - Two buttons: "Grid" and "Statistics"
      - Same segmented button style as OverlayToggle (inline-flex, rounded-lg, border)
      - Active: `bg-zinc-900 text-white dark:bg-zinc-100 dark:text-zinc-900`
      - Inactive: `bg-zinc-100 text-zinc-600 dark:bg-zinc-800 dark:text-zinc-400`
    - Conditionally render content based on activeTab:
      - `"grid"`: Existing FilterSidebar + ImageGrid layout
      - `"statistics"`: StatsDashboard component
    - SampleModal remains always mounted (it's controlled by its own state)
  </action>
  <verify>
    - `cd frontend && npx tsc --noEmit` -- no TypeScript errors
    - `cd frontend && npm run build` -- builds successfully
    - Visual check: Navigate to dataset page, verify "Grid" and "Statistics" tabs appear
    - Visual check: Click "Statistics" tab, verify dashboard renders with charts
    - Visual check: Summary cards show correct numbers
    - Visual check: Class distribution bar chart shows GT and prediction bars
    - Visual check: Split breakdown bar chart shows train/val/test counts
  </verify>
  <done>
    Dataset page has a Grid/Statistics tab system. The Statistics tab renders an interactive dashboard with: (1) summary stat cards for images, GT annotations, predictions, and categories; (2) a horizontal bar chart showing class distribution with GT and prediction counts side-by-side; (3) a vertical bar chart showing split breakdown. All data is fetched from the backend statistics endpoint and computed server-side by DuckDB.
  </done>
</task>

</tasks>

<verification>
1. `python -m pytest tests/ -v` -- all backend tests pass
2. `cd frontend && npx tsc --noEmit` -- no TypeScript errors
3. `cd frontend && npm run build` -- frontend builds successfully
4. GET /datasets/{id}/statistics returns structured JSON
5. Tab switching works between Grid and Statistics views
6. Charts render with correct data
7. Dashboard handles empty state (no predictions) gracefully
</verification>

<success_criteria>
- GET /datasets/{dataset_id}/statistics returns class distribution, split breakdown, and summary statistics
- Statistics dashboard renders Recharts bar charts with responsive sizing
- Tab system switches between Grid and Statistics without page reload
- Summary cards display total images, GT annotations, predictions, categories
- Class distribution chart shows GT and prediction counts side by side per class
- Split breakdown chart shows sample counts per split
</success_criteria>

<output>
After completion, create `.planning/phases/04-predictions-comparison/04-03-SUMMARY.md`
</output>
