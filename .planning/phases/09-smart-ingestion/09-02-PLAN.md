---
phase: 09-smart-ingestion
plan: 02
type: execute
wave: 2
depends_on: ["09-01"]
files_modified:
  - frontend/src/types/scan.ts
  - frontend/src/stores/ingest-store.ts
  - frontend/src/hooks/use-scan.ts
  - frontend/src/hooks/use-ingest-progress.ts
  - frontend/src/components/ingest/path-input.tsx
  - frontend/src/components/ingest/scan-results.tsx
  - frontend/src/components/ingest/import-progress.tsx
  - frontend/src/app/ingest/page.tsx
  - frontend/src/app/page.tsx
autonomous: false

must_haves:
  truths:
    - "User can navigate to /ingest from the landing page via an Import Dataset button"
    - "User can enter a folder path and trigger a scan that shows detected splits"
    - "User can review detected splits with image counts and toggle individual splits on/off"
    - "User can start import and see real-time per-split progress via SSE streaming"
    - "Import completion redirects or shows success with a link to the dataset"
  artifacts:
    - path: "frontend/src/types/scan.ts"
      provides: "TypeScript types matching backend ScanResult, DetectedSplit, ImportRequest"
      contains: "ScanResult"
    - path: "frontend/src/stores/ingest-store.ts"
      provides: "Zustand store for wizard step, scan results, selected splits"
      contains: "useIngestStore"
    - path: "frontend/src/hooks/use-scan.ts"
      provides: "TanStack Query mutation for POST /ingestion/scan"
      contains: "useScanFolder"
    - path: "frontend/src/hooks/use-ingest-progress.ts"
      provides: "POST SSE streaming hook for import progress"
      contains: "useIngestProgress"
    - path: "frontend/src/app/ingest/page.tsx"
      provides: "Three-step wizard page routing between PathInput, ScanResults, ImportProgress"
      contains: "useIngestStore"
    - path: "frontend/src/app/page.tsx"
      provides: "Import Dataset link on landing page"
      contains: "/ingest"
  key_links:
    - from: "frontend/src/hooks/use-scan.ts"
      to: "/ingestion/scan"
      via: "apiPost mutation to backend scan endpoint"
      pattern: "/ingestion/scan"
    - from: "frontend/src/hooks/use-ingest-progress.ts"
      to: "/ingestion/import"
      via: "fetch POST with ReadableStream for SSE consumption"
      pattern: "/ingestion/import"
    - from: "frontend/src/app/ingest/page.tsx"
      to: "frontend/src/stores/ingest-store.ts"
      via: "wizard step state drives conditional rendering"
      pattern: "useIngestStore"
    - from: "frontend/src/app/page.tsx"
      to: "frontend/src/app/ingest/page.tsx"
      via: "Next.js Link to /ingest"
      pattern: "href.*ingest"
---

<objective>
Build the frontend ingestion wizard -- a three-step UI flow (path input, structure confirmation, import progress) that consumes the backend scan and import APIs from Plan 09-01.

Purpose: This is the user-facing half of smart ingestion. The wizard transforms dataset import from a CLI/API operation into a guided no-code experience. Users enter a path, review the detected structure, confirm, and watch progress -- all in the browser.
Output: /ingest wizard page with 3 step components, Zustand store, scan mutation hook, SSE progress hook, TypeScript types, and landing page import link
</objective>

<execution_context>
@/Users/ortizeg/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ortizeg/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-smart-ingestion/09-RESEARCH.md
@.planning/phases/09-smart-ingestion/09-01-SUMMARY.md

@frontend/src/app/page.tsx
@frontend/src/lib/api.ts
@frontend/src/lib/constants.ts
@frontend/src/stores/ui-store.ts
@frontend/src/hooks/use-embedding-progress.ts
@frontend/src/types/dataset.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create TypeScript types, Zustand store, hooks, and page shell</name>
  <files>frontend/src/types/scan.ts, frontend/src/stores/ingest-store.ts, frontend/src/hooks/use-scan.ts, frontend/src/hooks/use-ingest-progress.ts, frontend/src/app/ingest/page.tsx, frontend/src/app/page.tsx</files>
  <action>
**Create `frontend/src/types/scan.ts`** with types matching the backend models:

```typescript
export interface DetectedSplit {
  name: string;
  annotation_path: string;
  image_dir: string;
  image_count: number;
  annotation_file_size: number;
}

export interface ScanResult {
  root_path: string;
  dataset_name: string;
  format: string;
  splits: DetectedSplit[];
  warnings: string[];
}

export interface ImportSplit {
  name: string;
  annotation_path: string;
  image_dir: string;
}

export interface ImportRequest {
  dataset_name: string;
  splits: ImportSplit[];
}

export interface IngestProgress {
  stage: string;        // "split_start" | "categories" | "parsing_images" | "parsing_annotations" | "thumbnails" | "complete"
  current: number;
  total: number | null;
  message: string;
}
```

**Create `frontend/src/stores/ingest-store.ts`** -- Zustand store for wizard state:

Follow the exact pattern from `ui-store.ts` (create from zustand, typed interface + actions).

State:
- `step: "input" | "confirm" | "importing" | "done"` (default: "input")
- `scanResult: ScanResult | null` (default: null)
- `selectedSplits: Set<string>` (default: empty -- populated from scan result)
- `datasetName: string` (default: "" -- populated from scan result)
- `error: string | null` (default: null)

Actions:
- `setScanResult(result: ScanResult)`: Set scanResult, populate selectedSplits with all split names, set datasetName from result.dataset_name, advance step to "confirm"
- `toggleSplit(name: string)`: Toggle a split name in/out of selectedSplits
- `setDatasetName(name: string)`: Update dataset name
- `startImport()`: Set step to "importing"
- `setDone()`: Set step to "done"
- `setError(error: string)`: Set error message
- `reset()`: Reset all state to defaults (for "Import Another" flow)

**Create `frontend/src/hooks/use-scan.ts`** -- TanStack Query mutation:

```typescript
import { useMutation } from "@tanstack/react-query";
import { apiPost } from "@/lib/api";
import type { ScanResult } from "@/types/scan";

export function useScanFolder() {
  return useMutation({
    mutationFn: (rootPath: string) =>
      apiPost<ScanResult>("/ingestion/scan", { root_path: rootPath }),
  });
}
```

This is a simple mutation hook. The component using it will call `mutate(path)` and handle `onSuccess` / `onError`.

**Create `frontend/src/hooks/use-ingest-progress.ts`** -- POST SSE streaming hook:

IMPORTANT: This hook does NOT use EventSource (which is GET-only). It uses `fetch()` with `ReadableStream` because the import endpoint is POST.

The hook should:
1. Accept an `ImportRequest` body and an `enabled` boolean
2. When enabled, POST to `${API_BASE}/ingestion/import` with the request body
3. Read the response body as a stream using `response.body.getReader()`
4. Parse SSE `data:` lines from the stream into `IngestProgress` objects
5. Expose current progress, isImporting boolean, and error state via React state
6. Call `onComplete` callback when stage === "complete"
7. Handle connection errors gracefully

Pattern to follow from research (NOT EventSource):
```typescript
const response = await fetch(`${API_BASE}/ingestion/import`, {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify(importRequest),
});
const reader = response.body!.getReader();
const decoder = new TextDecoder();
let buffer = "";
while (true) {
  const { done, value } = await reader.read();
  if (done) break;
  buffer += decoder.decode(value, { stream: true });
  const parts = buffer.split("\n\n");
  buffer = parts.pop() ?? "";
  for (const part of parts) {
    if (part.trim().startsWith("data: ")) {
      const data = JSON.parse(part.trim().slice(6));
      // update progress state
    }
  }
}
```

Expose as a custom hook that returns `{ progress, isImporting, error, startImport }` where `startImport` takes an `ImportRequest`.

**Create `frontend/src/app/ingest/page.tsx`** -- Wizard page shell:

```tsx
"use client";

import { useIngestStore } from "@/stores/ingest-store";
import PathInput from "@/components/ingest/path-input";
import ScanResults from "@/components/ingest/scan-results";
import ImportProgress from "@/components/ingest/import-progress";

export default function IngestPage() {
  const { step } = useIngestStore();

  return (
    <div className="min-h-screen bg-zinc-50 p-8 dark:bg-zinc-950">
      <header className="mb-8">
        <h1 className="text-2xl font-bold tracking-tight text-zinc-900 dark:text-zinc-50">
          Import Dataset
        </h1>
        <StepIndicator current={step} />
      </header>

      <main className="mx-auto max-w-2xl">
        {step === "input" && <PathInput />}
        {step === "confirm" && <ScanResults />}
        {(step === "importing" || step === "done") && <ImportProgress />}
      </main>
    </div>
  );
}
```

Include a simple `StepIndicator` component (inline or extracted) that shows 3 steps with visual progress (circles/lines). Steps: "Select Folder", "Review Structure", "Import". Use Tailwind styling consistent with the project (zinc color palette, dark mode support).

Add a "Back to Home" link at the top using Next.js `Link` pointing to `/`.

**Modify `frontend/src/app/page.tsx`** -- Add Import Dataset link:

In the landing page, add an "Import Dataset" button/link in TWO places:

1. In the empty state (when no datasets found), replace the plain text with an actionable message:
   ```tsx
   <p className="text-zinc-500 dark:text-zinc-400">
     No datasets found.{" "}
     <Link href="/ingest" className="text-blue-600 hover:underline dark:text-blue-400">
       Import a dataset
     </Link>{" "}
     to get started.
   </p>
   ```

2. In the header area, add an Import button that is always visible:
   ```tsx
   <Link
     href="/ingest"
     className="rounded-lg bg-blue-600 px-4 py-2 text-sm font-medium text-white hover:bg-blue-700"
   >
     Import Dataset
   </Link>
   ```

This ensures users always have access to the import flow whether they have datasets or not.
  </action>
  <verify>
Run: `cd "/Users/ortizeg/1Projects/⛹️‍♂️ Next Play/code/data-visor/frontend" && npx tsc --noEmit 2>&1 | tail -5` to confirm TypeScript compiles with zero errors.
Run: `cd "/Users/ortizeg/1Projects/⛹️‍♂️ Next Play/code/data-visor/frontend" && npx next build 2>&1 | tail -10` to confirm the build succeeds (the /ingest page is found by Next.js).
  </verify>
  <done>
TypeScript types, Zustand store, scan mutation hook, SSE progress hook, wizard page shell, and landing page Import link all exist. TypeScript compiles with zero errors. Next.js build succeeds and recognizes the /ingest route.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build wizard step components (PathInput, ScanResults, ImportProgress)</name>
  <files>frontend/src/components/ingest/path-input.tsx, frontend/src/components/ingest/scan-results.tsx, frontend/src/components/ingest/import-progress.tsx</files>
  <action>
**Create `frontend/src/components/ingest/path-input.tsx`** -- Step 1 of wizard:

A simple form with:
- A text input for the folder path (full width, with placeholder "e.g., /data/datasets/coco2017")
- A "Scan" button that triggers the `useScanFolder` mutation
- Loading state: button shows spinner/text "Scanning..." while mutation is pending
- Error state: red banner below the input showing the error message (from API 400/404)
- On success: call `useIngestStore().setScanResult(result)` which advances to step "confirm"

Styling: Use Tailwind classes consistent with the project (zinc borders, rounded-lg, blue primary button). Support dark mode.

The component should be self-contained: it manages the mutation internally and updates the Zustand store on success.

**Create `frontend/src/components/ingest/scan-results.tsx`** -- Step 2 of wizard:

Displays the scan result for user confirmation:

- Dataset name as an editable text input (pre-populated from scanResult.dataset_name, bound to `useIngestStore().setDatasetName()`)
- Format badge (e.g., "COCO")
- Root path displayed as muted text
- **Splits table/list** showing each detected split:
  - Checkbox (checked by default) to include/exclude the split -- bound to `toggleSplit()`
  - Split name (train, val, test) with a colored badge
  - Image count (formatted with .toLocaleString())
  - Annotation file size (formatted as KB/MB)
  - Image directory path (truncated, muted text)
- Warnings section: if scanResult.warnings is non-empty, show a yellow warning banner listing them
- Action buttons at bottom:
  - "Back" button: calls `reset()` to go back to path input
  - "Import Selected" button: calls `startImport()` to advance to step "importing"
  - "Import Selected" is disabled if no splits are selected (selectedSplits is empty)

Styling: Card layout with sections for dataset info and splits list. Dark mode support.

**Create `frontend/src/components/ingest/import-progress.tsx`** -- Step 3 of wizard:

Uses the `useIngestProgress` hook to stream import progress:

- On mount (when step === "importing"), construct the `ImportRequest` from Zustand store state and call `startImport()`
- Display overall progress: "Importing split 2/3: val"
- Per-split progress bar: show current stage (categories, parsing_images, parsing_annotations, thumbnails)
- Progress messages displayed in a scrollable log area (newest at bottom)
- When all splits complete (stage === "complete" on the last split):
  - Show success message with total counts
  - Call `useIngestStore().setDone()`
  - Show a "View Dataset" link (using Next.js Link to `/datasets/{dataset_id}`)
  - Show an "Import Another" button that calls `reset()` to start over
- Error handling: if the stream errors, show error message with a "Try Again" button

The import progress should invalidate the datasets query cache on completion so the landing page reflects the new dataset. Use `useQueryClient().invalidateQueries({ queryKey: ["datasets"] })`.

Styling: Progress bar using Tailwind (bg-blue-600 width via style%), status text, log area with monospace font for messages. Dark mode support.
  </action>
  <verify>
Run: `cd "/Users/ortizeg/1Projects/⛹️‍♂️ Next Play/code/data-visor/frontend" && npx tsc --noEmit 2>&1 | tail -5` to confirm TypeScript compiles with zero errors.
Run: `cd "/Users/ortizeg/1Projects/⛹️‍♂️ Next Play/code/data-visor/frontend" && npx next build 2>&1 | tail -10` to confirm the build succeeds.
  </verify>
  <done>
PathInput component triggers scan and advances wizard on success. ScanResults component shows detected splits with toggles, editable name, and import button. ImportProgress component streams SSE progress with per-split status and shows completion state. TypeScript compiles with zero errors. Next.js build succeeds.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete smart ingestion flow: backend folder scanner with COCO detection, scan/import API endpoints, and frontend 3-step wizard (path input, structure confirmation, SSE import progress).
  </what-built>
  <how-to-verify>
1. Start the backend: `cd "/Users/ortizeg/1Projects/⛹️‍♂️ Next Play/code/data-visor" && uvicorn app.main:app --reload`
2. Start the frontend: `cd "/Users/ortizeg/1Projects/⛹️‍♂️ Next Play/code/data-visor/frontend" && npm run dev`
3. Open http://localhost:3000 -- verify the "Import Dataset" button is visible in the header
4. Click "Import Dataset" -- verify you land on /ingest with the path input step
5. Enter a path to a COCO dataset folder and click "Scan"
6. Verify the detected splits are shown with image counts and checkboxes
7. Optionally toggle splits on/off and edit the dataset name
8. Click "Import Selected" and verify real-time progress updates appear
9. After completion, verify the "View Dataset" link works and the dataset appears on the landing page
10. If no COCO dataset is available, test the scan with an invalid path to verify error handling (400 or 404 response shown as red banner)
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` in frontend/ passes with zero errors
2. `npx next build` in frontend/ succeeds
3. `pytest tests/ -x -q` in project root passes
4. Navigating to http://localhost:3000/ingest shows the wizard
5. Landing page has "Import Dataset" button visible
6. Scan endpoint returns detected splits for a valid COCO folder
7. Import streams SSE progress and creates the dataset in DuckDB
</verification>

<success_criteria>
- User can navigate from landing page to /ingest via Import Dataset button
- Path input step accepts a folder path, shows loading state during scan, and displays errors
- Scan results step shows detected splits with checkboxes, image counts, and editable dataset name
- Import progress step streams real-time SSE events with per-split status
- Import completion shows success state with link to dataset and option to import another
- All TypeScript compiles with zero errors
</success_criteria>

<output>
After completion, create `.planning/phases/09-smart-ingestion/09-02-SUMMARY.md`
</output>
