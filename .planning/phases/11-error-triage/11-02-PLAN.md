---
phase: 11-error-triage
plan: 02
type: execute
wave: 2
depends_on: ["11-01"]
files_modified:
  - frontend/src/stores/ui-store.ts
  - frontend/src/components/grid/grid-cell.tsx
  - frontend/src/components/detail/sample-modal.tsx
  - frontend/src/components/triage/triage-tag-buttons.tsx
  - frontend/src/components/triage/worst-images-panel.tsx
  - frontend/src/components/stats/stats-dashboard.tsx
autonomous: true

must_haves:
  truths:
    - "User can tag a sample as FP/TP/FN/mistake via buttons in the detail modal, and the tag persists after closing and reopening"
    - "User can change a triage tag by clicking a different button (previous tag is replaced, not accumulated)"
    - "User can remove a triage tag by clicking the active tag button again"
    - "User can toggle highlight mode and non-triage-tagged samples dim to 20% opacity in the grid"
    - "User can view a worst-images ranking tab in the statistics dashboard showing samples sorted by error score"
    - "Worst-images tab only appears when predictions exist (same guard as error analysis)"
  artifacts:
    - path: "frontend/src/components/triage/triage-tag-buttons.tsx"
      provides: "TriageTagButtons component with FP/TP/FN/mistake quick-tag buttons"
      min_lines: 30
    - path: "frontend/src/components/triage/worst-images-panel.tsx"
      provides: "WorstImagesPanel showing ranked samples by error score"
      min_lines: 40
    - path: "frontend/src/stores/ui-store.ts"
      provides: "isHighlightMode state + toggleHighlightMode action"
      contains: "isHighlightMode"
    - path: "frontend/src/components/grid/grid-cell.tsx"
      provides: "Highlight mode dimming for non-triage-tagged samples"
      contains: "isHighlightMode"
    - path: "frontend/src/components/detail/sample-modal.tsx"
      provides: "TriageTagButtons integration in detail modal"
      contains: "TriageTagButtons"
    - path: "frontend/src/components/stats/stats-dashboard.tsx"
      provides: "Worst Images sub-tab in statistics dashboard"
      contains: "worst"
  key_links:
    - from: "frontend/src/components/triage/triage-tag-buttons.tsx"
      to: "frontend/src/hooks/use-triage.ts"
      via: "useSetTriageTag and useRemoveTriageTag mutations"
      pattern: "useSetTriageTag|useRemoveTriageTag"
    - from: "frontend/src/components/triage/worst-images-panel.tsx"
      to: "frontend/src/hooks/use-triage.ts"
      via: "useWorstImages query hook"
      pattern: "useWorstImages"
    - from: "frontend/src/components/grid/grid-cell.tsx"
      to: "frontend/src/stores/ui-store.ts"
      via: "isHighlightMode store selector"
      pattern: "useUIStore.*isHighlightMode"
    - from: "frontend/src/components/detail/sample-modal.tsx"
      to: "frontend/src/components/triage/triage-tag-buttons.tsx"
      via: "component import and render"
      pattern: "TriageTagButtons"
---

<objective>
Build the triage UI: quick-tag buttons in the sample detail modal, highlight mode toggle + grid cell dimming, and worst-images ranking panel in the statistics dashboard.

Purpose: Connects Plan 01's backend endpoints and hooks to user-facing UI, completing the triage workflow. Users can tag samples during review, visually identify errors in the grid, and find the worst samples via the statistics dashboard.

Output: Two new triage components, modifications to ui-store (highlight mode), grid-cell (dimming), sample-modal (triage buttons), and stats-dashboard (worst-images tab).
</objective>

<execution_context>
@/Users/ortizeg/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ortizeg/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-error-triage/11-RESEARCH.md
@.planning/phases/11-error-triage/11-01-SUMMARY.md

@frontend/src/stores/ui-store.ts (add isHighlightMode + toggleHighlightMode)
@frontend/src/components/grid/grid-cell.tsx (add highlight dimming)
@frontend/src/components/detail/sample-modal.tsx (add triage buttons)
@frontend/src/components/stats/stats-dashboard.tsx (add worst-images tab)
@frontend/src/components/stats/error-analysis-panel.tsx (reference for controls bar pattern)
@frontend/src/hooks/use-triage.ts (from Plan 01 -- useSetTriageTag, useRemoveTriageTag, useWorstImages)
@frontend/src/types/triage.ts (from Plan 01 -- TRIAGE_OPTIONS, TriageTag)
@frontend/src/lib/api.ts (thumbnailUrl for worst-images thumbnails)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Triage tag buttons component + highlight mode in UI store + grid dimming</name>
  <files>
    frontend/src/components/triage/triage-tag-buttons.tsx
    frontend/src/stores/ui-store.ts
    frontend/src/components/grid/grid-cell.tsx
    frontend/src/components/detail/sample-modal.tsx
  </files>
  <action>
    **1. Create `frontend/src/components/triage/triage-tag-buttons.tsx`:**
    - Props: `datasetId: string`, `sampleId: string`, `currentTags: string[]` (the sample's tags array)
    - Derive `activeTriageTag` from `currentTags.find(t => t.startsWith("triage:")) ?? null`
    - Import `TRIAGE_OPTIONS` from `@/types/triage` and `useSetTriageTag`, `useRemoveTriageTag` from `@/hooks/use-triage`
    - Render a row of 4 small buttons (TP, FP, FN, Mistake) using TRIAGE_OPTIONS
    - Each button: if clicking the already-active tag, call `removeTriageTag.mutate({dataset_id: datasetId, sample_id: sampleId})`; otherwise call `setTriageTag.mutate({dataset_id: datasetId, sample_id: sampleId, tag: option.tag})`
    - Active button gets its colorClass (filled), inactive buttons get a subtle outline style: `border border-zinc-300 dark:border-zinc-600 text-zinc-600 dark:text-zinc-400 hover:bg-zinc-100 dark:hover:bg-zinc-700`
    - Active button text is white. Each button is `px-2 py-1 rounded text-xs font-medium transition-colors`
    - Add a label "Triage:" before the buttons row in `text-xs font-medium text-zinc-500`

    **2. Extend `frontend/src/stores/ui-store.ts`:**
    - Add to UIState interface: `isHighlightMode: boolean` and `toggleHighlightMode: () => void`
    - Add initial state: `isHighlightMode: false`
    - Add action: `toggleHighlightMode: () => set((s) => ({ isHighlightMode: !s.isHighlightMode }))`

    **3. Modify `frontend/src/components/grid/grid-cell.tsx`:**
    - Add import: `const isHighlightMode = useUIStore((s) => s.isHighlightMode);`
    - Derive `hasTriageTag`: `const hasTriageTag = tags.some((t) => t.startsWith("triage:"));`
    - On the outer `<button>` element, add a conditional class: when `isHighlightMode && !hasTriageTag`, apply `opacity-20` to the button. This dims the entire cell (image + filename + tag badges) for non-triaged samples.
    - Specifically: modify the className template literal to include `${isHighlightMode && !hasTriageTag ? "opacity-20" : ""}`
    - Also: render triage tag badges with color-coded backgrounds instead of the default blue. Check if a tag starts with "triage:" and use the appropriate color: triage:tp = green, triage:fp = red, triage:fn = orange, triage:mistake = amber. Non-triage tags keep the existing blue style.

    **4. Modify `frontend/src/components/detail/sample-modal.tsx`:**
    - Import `TriageTagButtons` from `@/components/triage/triage-tag-buttons`
    - Import `useUIStore` selector for `isHighlightMode` and `toggleHighlightMode`
    - Add the triage buttons in the edit toolbar bar (the `<div>` with `flex items-center gap-2 border-b`), placed at the right side (before the span that shows edit mode hint, or after the existing buttons). Add them as: `<TriageTagButtons datasetId={datasetId} sampleId={sample.id} currentTags={sample.tags ?? []} />`
    - Also add a highlight mode toggle button in the toolbar: a small button with an eye icon (or text "Highlight") that calls `toggleHighlightMode()`. Style it similar to the Edit button: when `isHighlightMode` is active, use `bg-yellow-500 text-white`, otherwise use the default zinc style. Place this button with `ml-auto` to push it to the right side.
    - The triage buttons should always be visible (not gated by edit mode) since triage is a separate workflow from annotation editing.
  </action>
  <verify>
    Run `cd /Users/ortizeg/1Projects/⛹️‍♂️\ Next\ Play/code/data-visor/frontend && npx tsc --noEmit` to verify TypeScript compiles with 0 errors.
  </verify>
  <done>
    - TriageTagButtons component renders 4 buttons and correctly calls set/remove triage tag mutations
    - Active triage tag shows as filled button, others show as outline
    - UI store has isHighlightMode boolean with toggle action
    - Grid cells dim to 20% opacity when highlight mode is active and sample has no triage tag
    - Triage tag badges in grid cells use color-coded backgrounds (green/red/orange/amber)
    - Detail modal toolbar shows triage buttons and highlight mode toggle
  </done>
</task>

<task type="auto">
  <name>Task 2: Worst-images panel in statistics dashboard</name>
  <files>
    frontend/src/components/triage/worst-images-panel.tsx
    frontend/src/components/stats/stats-dashboard.tsx
  </files>
  <action>
    **1. Create `frontend/src/components/triage/worst-images-panel.tsx`:**
    - Props: `datasetId: string`, `split: string | null`
    - Uses the same controls-bar pattern as ErrorAnalysisPanel: source dropdown, IoU slider (0.1-1.0, step 0.05), confidence slider (0.0-1.0, step 0.05)
    - Copy the `useDebouncedValue` hook inline (same as error-analysis-panel does) or import if available
    - Auto-select first available prediction source using `useFilterFacets` (same pattern as ErrorAnalysisPanel)
    - Call `useWorstImages(datasetId, source, debouncedIou, debouncedConf, split, true)` from `@/hooks/use-triage`
    - Render a ranked list of worst samples as a vertical list/grid:
      - Each item shows: rank number (#1, #2...), thumbnail (using `thumbnailUrl(datasetId, score.sample_id)`), error count, confidence spread (2 decimals), composite score (2 decimals)
      - Layout: flex row per item. Thumbnail 64x64px rounded, rank number bold, stats as small text on the right.
      - Each item is clickable -- calls `useUIStore.getState().openDetailModal(score.sample_id)` to open the detail modal for that sample
    - Show skeleton/loading state while fetching
    - Show "No error data available" when items is empty
    - Show a subtle header: "Samples ranked by composite error score (60% error count + 40% confidence spread)"
    - Limit display to top 50 (the backend already caps at `limit` param, default 50)

    **2. Modify `frontend/src/components/stats/stats-dashboard.tsx`:**
    - Import `WorstImagesPanel` from `@/components/triage/worst-images-panel`
    - Add "Worst Images" as a new sub-tab option. Update the `SubTab` type to include `"worst_images"`. Add a tab button for it, placed after "Error Analysis" and before "Intelligence". Disable it when `!hasPredictions` (same guard as error analysis).
    - Render `<WorstImagesPanel datasetId={datasetId} split={split} />` when `activeTab === "worst_images" && hasPredictions`.
    - Style the tab button identically to the existing Error Analysis tab button.
  </action>
  <verify>
    Run `cd /Users/ortizeg/1Projects/⛹️‍♂️\ Next\ Play/code/data-visor/frontend && npx tsc --noEmit` to verify TypeScript compiles with 0 errors.
    Run `cd /Users/ortizeg/1Projects/⛹️‍♂️\ Next\ Play/code/data-visor/frontend && npm run build` to verify full production build succeeds.
  </verify>
  <done>
    - WorstImagesPanel renders ranked samples with thumbnails, scores, and click-to-open behavior
    - Stats dashboard has a "Worst Images" sub-tab that only appears when predictions exist
    - Controls bar matches the Error Analysis panel pattern (source, IoU, conf sliders)
    - Frontend builds successfully with no errors
  </done>
</task>

</tasks>

<verification>
1. TypeScript: `npx tsc --noEmit` -- 0 errors
2. Build: `npm run build` -- succeeds
3. UI store: `isHighlightMode` toggles correctly (default false)
4. Grid: non-triage-tagged cells have opacity-20 when highlight mode is on
5. Detail modal: triage buttons visible, clicking tags the sample (verify via page refresh)
6. Stats: "Worst Images" tab appears only when predictions exist and shows ranked list
</verification>

<success_criteria>
- Triage tag buttons in detail modal allow tagging samples as TP/FP/FN/mistake with atomic replacement
- Highlight mode toggle dims non-triaged grid cells to 20% opacity
- Triage tag badges in grid cells are color-coded (not default blue)
- Worst-images panel in stats dashboard shows ranked samples with error scores
- Full frontend build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/11-error-triage/11-02-SUMMARY.md`
</output>
