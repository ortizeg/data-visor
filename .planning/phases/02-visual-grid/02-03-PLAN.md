---
phase: 02-visual-grid
plan: 03
type: execute
wave: 3
depends_on: ["02-02"]
files_modified:
  - frontend/src/components/detail/sample-modal.tsx
  - frontend/src/components/detail/annotation-list.tsx
  - frontend/src/app/datasets/[datasetId]/page.tsx
  - frontend/src/hooks/use-annotations.ts
autonomous: false

must_haves:
  truths:
    - "User can click any thumbnail to open a detail modal"
    - "Detail modal shows the full-resolution image with annotation overlays"
    - "Detail modal displays all sample metadata (filename, dimensions, split)"
    - "Detail modal lists all annotations with class name, bbox coordinates, and area"
    - "User can close the modal with Escape key or clicking outside"
  artifacts:
    - path: "frontend/src/components/detail/sample-modal.tsx"
      provides: "Full-resolution detail modal with annotations"
      min_lines: 50
    - path: "frontend/src/components/detail/annotation-list.tsx"
      provides: "Tabular annotation metadata display"
      min_lines: 25
  key_links:
    - from: "frontend/src/components/detail/sample-modal.tsx"
      to: "frontend/src/stores/ui-store.ts"
      via: "useUIStore for selectedSampleId and modal open/close"
      pattern: "useUIStore"
    - from: "frontend/src/components/detail/sample-modal.tsx"
      to: "frontend/src/components/grid/annotation-overlay.tsx"
      via: "Reuses AnnotationOverlay for full-res image"
      pattern: "AnnotationOverlay"
    - from: "frontend/src/components/detail/sample-modal.tsx"
      to: "http://localhost:8000/images"
      via: "fullImageUrl for full-resolution image src"
      pattern: "fullImageUrl"
    - from: "frontend/src/components/grid/grid-cell.tsx"
      to: "frontend/src/stores/ui-store.ts"
      via: "onClick calls openDetailModal(sample.id)"
      pattern: "openDetailModal"
---

<objective>
Build the sample detail modal that opens when a user clicks any grid thumbnail, displaying the full-resolution image with annotation overlays and complete metadata.

Purpose: The grid provides an overview, but users need to zoom in on individual samples to inspect annotations, verify labels, and see detailed metadata. The modal is the drill-down view -- full resolution with every annotation listed.

Output: A working detail modal accessible from any grid cell click, showing full-res image, SVG annotation overlays, and a metadata/annotation table.
</objective>

<execution_context>
@/Users/ortizeg/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ortizeg/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-visual-grid/02-RESEARCH.md
@.planning/phases/02-visual-grid/02-01-SUMMARY.md
@.planning/phases/02-visual-grid/02-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build detail modal with full-resolution image, annotations, and metadata</name>
  <files>
    frontend/src/components/detail/sample-modal.tsx
    frontend/src/components/detail/annotation-list.tsx
    frontend/src/hooks/use-annotations.ts
    frontend/src/app/datasets/[datasetId]/page.tsx
  </files>
  <action>
    1. Create `src/components/detail/annotation-list.tsx` ('use client'):
       - Accept `annotations: Annotation[]` prop
       - Render a table (or styled list) showing each annotation's:
         - Class name (with colored dot using getClassColor)
         - Bounding box: formatted as "x, y, w x h" (rounded to 1 decimal)
         - Area (formatted with locale number formatting)
         - Source (e.g., "ground_truth")
         - Confidence (if not null, formatted as percentage)
       - Tailwind styling: compact table with alternating row colors, sticky header
       - Show count header: "{N} annotations"

    2. Create `src/components/detail/sample-modal.tsx` ('use client'):
       - Use the native HTML `<dialog>` element (handles focus trap, Escape key, backdrop, accessibility)
       - Read `selectedSampleId` and `isDetailModalOpen` from `useUIStore`
       - When `isDetailModalOpen` changes, call `dialogRef.current?.showModal()` or `dialogRef.current?.close()` via `useEffect`
       - Listen to dialog's `onClose` event to call `closeDetailModal()`
       - When a sample is selected, find it from the TanStack Query cache or accept it as a prop. Simplest approach: accept `samples: Sample[]` as a prop and find by ID, since all loaded samples are already in the grid's query cache. Alternatively, use a simple useQuery for `GET /samples?dataset_id=X&limit=1&offset=0` filtered -- but there's no GET /samples/{id} endpoint. Use the samples array approach.
       - Fetch annotations for the selected sample using a single-sample query to `GET /samples/{sample_id}/annotations?dataset_id=X` (existing endpoint is fine for one sample)
       - Add or extend `use-annotations.ts` with a `useAnnotations(datasetId, sampleId)` hook:
         - queryKey: ['annotations', sampleId, datasetId]
         - Calls the existing per-sample endpoint
         - staleTime: Infinity
         - enabled: !!sampleId
       - Layout the modal:
         - Max width: max-w-6xl, centered
         - Top section: relative container with full-res `<img>` using `fullImageUrl(datasetId, selectedSampleId)` and `<AnnotationOverlay>` (reuse from grid)
         - Bottom section: two-column layout
           - Left: metadata panel showing file_name, dimensions (width x height), split, dataset_id
           - Right: `<AnnotationList>` component
         - Close button (X) in top-right corner
       - Backdrop: backdrop:bg-black/60

    3. Mount `<SampleModal>` in the dataset page (`src/app/datasets/[datasetId]/page.tsx`):
       - Add `<SampleModal datasetId={datasetId} samples={allSamples} />` alongside the grid
       - Pass the flattened samples array from useSamples so the modal can look up the selected sample

    AVOID:
    - Do NOT build a custom modal with portals -- use native `<dialog>` element (handles accessibility, focus trap, Escape key for free)
    - Do NOT fetch the full sample list again for the modal -- reuse the samples already loaded in the grid's query cache
    - Do NOT use the batch annotations endpoint for the modal -- the per-sample endpoint is fine for a single detail view
    - Do NOT forget to add `decoding="async"` on the full-res img (it may be large)
  </action>
  <verify>
    1. Start backend and frontend
    2. Navigate to a dataset grid
    3. Click any thumbnail -- modal opens with full-resolution image
    4. Verify: annotation overlays visible on full-res image
    5. Verify: metadata panel shows filename, dimensions
    6. Verify: annotation list table shows all annotations with colored class indicators
    7. Press Escape -- modal closes
    8. Click backdrop -- modal closes
    9. `cd frontend && npm run build` -- no TypeScript errors
  </verify>
  <done>
    Clicking any grid thumbnail opens a detail modal showing full-resolution image with SVG annotation overlays, sample metadata, and a tabular list of all annotations with class colors. Modal closes via Escape key, backdrop click, or close button.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Complete Phase 2 Visual Grid implementation:
    1. Virtualized image grid with infinite scroll (100K+ capable)
    2. SVG annotation overlays with deterministic class colors on every thumbnail
    3. Detail modal with full-resolution image, annotation overlays, and metadata table
    4. Batch annotation fetching to avoid request waterfalls
    5. Responsive grid columns (3-10 based on viewport width)
  </what-built>
  <how-to-verify>
    Prerequisites: Backend must be running with at least one ingested COCO dataset.

    1. Open http://localhost:3000 -- you should see a dataset list
    2. Click a dataset -- virtualized grid of thumbnails should load
    3. Scroll down -- more thumbnails should load automatically (check Network tab for paginated requests)
    4. Verify bounding boxes visible on thumbnails:
       - Colored rectangles around detected objects
       - Class labels above each box
       - Same class name = same color everywhere
    5. Click any thumbnail -- detail modal should open:
       - Full-resolution image with annotation overlays
       - Metadata (filename, dimensions) visible
       - Annotation list/table with class names and coordinates
    6. Press Escape or click outside modal -- it should close
    7. Resize browser window -- grid columns should adjust (fewer columns when narrow, more when wide)
    8. Scroll rapidly through many images -- UI should remain responsive (no lag/freeze)
  </how-to-verify>
  <resume-signal>Type "approved" or describe any issues with the visual grid, annotations, or modal</resume-signal>
</task>

</tasks>

<verification>
1. Grid thumbnails show annotation overlays with class-colored bounding boxes
2. Detail modal opens on click with full-res image and metadata
3. Modal closes via Escape, backdrop click, or close button
4. All Phase 2 success criteria met:
   - GRID-01: Virtualized infinite scroll grid
   - GRID-02: Bounding box overlays with class labels
   - GRID-04: Deterministic class-to-color hashing
   - GRID-05: Detail modal with full-res image and metadata
5. `npm run build` passes with zero errors
</verification>

<success_criteria>
- Detail modal opens from any grid cell click
- Full-resolution image renders with annotation overlays
- Sample metadata (filename, dimensions, split) displayed
- Annotation list shows all annotations with class colors, bbox, area
- Modal is accessible (Escape to close, focus trapped)
- All four phase requirements (GRID-01, 02, 04, 05) verified by human
</success_criteria>

<output>
After completion, create `.planning/phases/02-visual-grid/02-03-SUMMARY.md`
</output>
