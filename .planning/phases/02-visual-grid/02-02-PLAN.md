---
phase: 02-visual-grid
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - app/routers/samples.py
  - frontend/src/components/grid/annotation-overlay.tsx
  - frontend/src/components/grid/grid-cell.tsx
  - frontend/src/hooks/use-annotations.ts
  - frontend/src/lib/color-hash.ts
autonomous: true

must_haves:
  truths:
    - "Bounding box annotations render on grid thumbnails with class labels visible"
    - "Each class name always maps to the same color deterministically"
    - "Annotations scale correctly regardless of thumbnail vs original image dimensions"
    - "Grid does not fire 40+ individual annotation requests per scroll position"
  artifacts:
    - path: "frontend/src/components/grid/annotation-overlay.tsx"
      provides: "SVG overlay rendering bounding boxes with labels"
      min_lines: 30
    - path: "frontend/src/lib/color-hash.ts"
      provides: "Deterministic class-to-color mapping"
      exports: ["getClassColor"]
    - path: "frontend/src/hooks/use-annotations.ts"
      provides: "Batch annotation fetching hook"
      min_lines: 15
    - path: "app/routers/samples.py"
      provides: "Batch annotation endpoint"
      contains: "sample_ids"
  key_links:
    - from: "frontend/src/components/grid/grid-cell.tsx"
      to: "frontend/src/components/grid/annotation-overlay.tsx"
      via: "AnnotationOverlay component rendered over thumbnail"
      pattern: "AnnotationOverlay"
    - from: "frontend/src/hooks/use-annotations.ts"
      to: "http://localhost:8000/annotations/batch"
      via: "apiFetch calling batch endpoint"
      pattern: "apiFetch.*annotations.*batch"
    - from: "frontend/src/components/grid/annotation-overlay.tsx"
      to: "frontend/src/lib/color-hash.ts"
      via: "getClassColor for stroke and text fill"
      pattern: "getClassColor"
    - from: "frontend/src/components/grid/annotation-overlay.tsx"
      to: "SVG viewBox"
      via: "viewBox matching original image dimensions for correct coordinate scaling"
      pattern: "viewBox.*imageWidth.*imageHeight"
---

<objective>
Add bounding box annotation overlays to grid thumbnails with deterministic class-to-color hashing. Includes a backend batch endpoint to avoid per-sample annotation request waterfalls.

Purpose: Annotations are core to DataVisor -- users need to see what's labeled in each image at a glance. Without batch fetching, the grid would fire 40-80 individual requests per scroll position, destroying performance. Without deterministic colors, class "person" would appear as different colors across page loads, confusing users.

Output: Grid thumbnails show SVG bounding box overlays with class labels in deterministic colors. Annotations are fetched in batches per page of visible samples.
</objective>

<execution_context>
@/Users/ortizeg/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ortizeg/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-visual-grid/02-RESEARCH.md
@.planning/phases/02-visual-grid/02-01-SUMMARY.md
@app/routers/samples.py
@app/models/annotation.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add batch annotation endpoint and create color-hash utility</name>
  <files>
    app/routers/samples.py
    frontend/src/lib/color-hash.ts
  </files>
  <action>
    1. Add a batch annotation endpoint to the backend `app/routers/samples.py`:

       `GET /annotations/batch?dataset_id=X&sample_ids=id1,id2,id3,...`
       - Accept `dataset_id` as required query param
       - Accept `sample_ids` as a comma-separated string query param (max 200 IDs)
       - Query DuckDB: `SELECT id, dataset_id, sample_id, category_name, bbox_x, bbox_y, bbox_w, bbox_h, area, is_crowd, source, confidence FROM annotations WHERE dataset_id = ? AND sample_id IN (?, ?, ...)`
       - Return `dict[str, list[AnnotationResponse]]` -- a mapping of sample_id to its annotations
       - Use a new Pydantic response model: `BatchAnnotationsResponse` with field `annotations: dict[str, list[AnnotationResponse]]`
       - Add this model to `app/models/annotation.py`

       NOTE: This endpoint belongs on a new router or the samples router. Since annotations are closely related to samples, add it to the samples router with prefix adjustment. Actually, add it as a separate route: `@router.get("/annotations/batch", ...)`. Wait -- the samples router has prefix="/samples". So the route would be `/samples/annotations/batch`. That's awkward. Instead, create a new `annotations` router OR add a standalone route. Simplest approach: add to samples router as `/batch-annotations` making the full path `/samples/batch-annotations?dataset_id=X&sample_ids=id1,id2`.

       Actually, cleanest approach: just add a new route to the samples router:
       ```python
       @router.get("/batch-annotations", response_model=BatchAnnotationsResponse)
       def get_batch_annotations(
           dataset_id: str = Query(...),
           sample_ids: str = Query(..., description="Comma-separated sample IDs"),
           db: DuckDBRepo = Depends(get_db),
       ) -> BatchAnnotationsResponse:
       ```
       The full URL becomes `GET /samples/batch-annotations?dataset_id=X&sample_ids=a,b,c`

    2. Create `frontend/src/lib/color-hash.ts`:
       ```typescript
       import ColorHash from 'color-hash';

       const colorHash = new ColorHash({
         saturation: [0.6, 0.7, 0.8],
         lightness: [0.45, 0.55, 0.65],
       });

       export function getClassColor(className: string): string {
         return colorHash.hex(className);
       }
       ```
       Simple module -- single instance, single exported function.

    AVOID:
    - Do NOT create a separate annotations router -- keep it in samples router for simplicity
    - Do NOT accept more than 200 sample_ids per batch request (protect against abuse)
    - Do NOT use `IN` clause with string interpolation -- use parameterized queries with dynamic placeholders
  </action>
  <verify>
    Backend: Start the server, run `curl "http://localhost:8000/samples/batch-annotations?dataset_id=SOME_ID&sample_ids=id1,id2"` -- should return JSON with annotations grouped by sample_id.

    Frontend: `cd frontend && npx tsc --noEmit` -- color-hash.ts compiles without errors.
  </verify>
  <done>
    Batch annotation endpoint returns annotations grouped by sample_id. Color-hash utility exports `getClassColor` function that deterministically maps class names to hex colors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build SVG annotation overlay and wire into grid cells</name>
  <files>
    frontend/src/components/grid/annotation-overlay.tsx
    frontend/src/hooks/use-annotations.ts
    frontend/src/components/grid/grid-cell.tsx
    frontend/src/types/annotation.ts
  </files>
  <action>
    1. Create `src/hooks/use-annotations.ts`:
       - Export `useAnnotationsBatch(datasetId: string, sampleIds: string[])` that wraps `useQuery`
       - queryKey: ['annotations-batch', datasetId, ...sampleIds.sort()] (sort for cache key stability)
       - queryFn: calls `apiFetch<BatchAnnotationsResponse>(`/samples/batch-annotations?dataset_id=${datasetId}&sample_ids=${sampleIds.join(',')}`)`
       - staleTime: Infinity (annotations don't change during session)
       - enabled: sampleIds.length > 0
       - Returns `data.annotations` -- a `Record<string, Annotation[]>`

       Add `BatchAnnotationsResponse` type to `src/types/annotation.ts`:
       ```typescript
       export interface BatchAnnotationsResponse {
         annotations: Record<string, Annotation[]>;
       }
       ```

    2. Create `src/components/grid/annotation-overlay.tsx` ('use client'):
       - Accept props: `annotations: Annotation[]`, `imageWidth: number`, `imageHeight: number`
       - Render an SVG element:
         - `viewBox={`0 0 ${imageWidth} ${imageHeight}`}` -- CRITICAL: must match original image dimensions, NOT thumbnail dimensions
         - `preserveAspectRatio="xMidYMid meet"` -- scales SVG to fit container while maintaining aspect ratio
         - `className="absolute inset-0 w-full h-full pointer-events-none"` -- overlays the img
       - For each annotation, render a `<g>` containing:
         - `<rect>` with x={bbox_x}, y={bbox_y}, width={bbox_w}, height={bbox_h}, fill="none", stroke={getClassColor(category_name)}, strokeWidth={Math.max(imageWidth * 0.003, 2)}
         - `<text>` with category_name label positioned above the rect (y={bbox_y - 4}), fontSize={Math.max(imageWidth * 0.015, 10)}, fontWeight="bold", fill={getClassColor(category_name)}
         - Add a dark text shadow/stroke for readability: use `paintOrder="stroke"` with a thin dark stroke behind the text fill

    3. Update `src/components/grid/image-grid.tsx`:
       - After computing visible sample IDs from the current virtual rows, call `useAnnotationsBatch(datasetId, visibleSampleIds)` at the grid level (NOT per-cell)
       - Pass the annotation map down to GridCell as a prop: `annotations={annotationMap?.[sample.id] ?? []}`

    4. Update `src/components/grid/grid-cell.tsx`:
       - Accept new prop: `annotations: Annotation[]`
       - Remove any per-cell annotation fetching
       - Wrap the `<img>` and `<AnnotationOverlay>` in a `relative` container
       - Render `<AnnotationOverlay>` only when annotations.length > 0
       - Pass sample.width and sample.height as imageWidth/imageHeight to the overlay

    AVOID:
    - Do NOT fetch annotations per-cell -- fetch at grid level for the visible batch
    - Do NOT set SVG viewBox to thumbnail dimensions -- MUST use original image dimensions (sample.width, sample.height) so annotation coordinates are correct
    - Do NOT forget pointer-events-none on SVG -- otherwise it blocks img click events
    - Do NOT use canvas/react-konva -- SVG is lighter for static display (research confirmed)
  </action>
  <verify>
    1. Start backend and frontend
    2. Navigate to a dataset with annotations
    3. Verify: bounding boxes appear on thumbnails as colored rectangles with class labels
    4. Verify: same class name shows same color across all thumbnails
    5. Verify: Network tab shows batch annotation requests (not per-cell requests)
    6. Verify: boxes are correctly positioned (match the objects in the images)
    7. `cd frontend && npm run build` -- no TypeScript errors
  </verify>
  <done>
    Bounding boxes render correctly on grid thumbnails via SVG overlay. Each class has a deterministic color. Annotations are batch-fetched per visible page (not per-cell). SVG viewBox scales coordinates from original image space to thumbnail display size.
  </done>
</task>

</tasks>

<verification>
1. Bounding boxes visible on grid thumbnails with class labels
2. Same class name = same color across all visible thumbnails (deterministic)
3. Network tab shows batch annotation requests grouped by visible samples
4. Boxes correctly positioned on objects (not shifted or scaled wrong)
5. `npm run build` passes
</verification>

<success_criteria>
- SVG annotation overlays render on thumbnails with class labels
- Color hashing is deterministic (same class = same color every session)
- Batch endpoint reduces annotation requests from 40-80 per scroll to 1 per scroll
- Annotation coordinates scale correctly via SVG viewBox
</success_criteria>

<output>
After completion, create `.planning/phases/02-visual-grid/02-02-SUMMARY.md`
</output>
